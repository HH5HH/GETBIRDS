<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GetBirds — Your postcards</title>
  <link rel="preconnect" href="https://accounts.google.com" />
  <link rel="preconnect" href="https://graphql.app-api.prod.aws.mybirdbuddy.com" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root {
      --bg: #f5f2eb;
      --surface: #fff;
      --surface-alt: #ebe7df;
      --border: #d4cfc4;
      --text: #1a1a1a;
      --text-soft: #4a4a4a;
      --muted: #6b6560;
      --accent: #2d5a4a;
      --accent-hover: #234a3d;
      --accent-light: #e8f0ee;
      --error: #c23d3d;
      --radius: 12px;
      --radius-sm: 8px;
      --media-radius: 22px;
      --shadow: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-hover: 0 4px 16px rgba(0,0,0,0.08);
    }

    html, body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: "Plus Jakarta Sans", system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .screen.hidden { display: none !important; }

    /* When login screen is visible it fully covers the viewport; no app UI shows through. */
    #loginScreen:not(.hidden) {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      z-index: 10;
    }

    .brand {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
    }

    .tagline {
      font-size: 0.9375rem;
      color: var(--text-soft);
      margin-bottom: 2rem;
    }

    .login-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.875rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
    }

    .login-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      box-shadow: var(--shadow-hover);
      transform: translateY(-1px);
    }

    .login-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .login-btn svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .logged-in {
      display: grid;
      grid-template-rows: auto minmax(0, 1fr) auto;
      height: 100vh;
      width: 100%;
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 40;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 0.875rem 1.25rem 0.75rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      gap: 0.7rem;
      box-shadow: var(--shadow);
    }

    .header-main {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      align-items: center;
      gap: 1rem;
      min-width: 0;
    }

    .header-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
      background: var(--surface-alt);
    }

    .header-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .header-status {
      flex: 1;
      min-width: 0;
      text-align: center;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-soft);
      padding: 0 1rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .header-status:empty { display: none; }
    .header-status.error { color: var(--error); }
    .header-status.youtube-limit {
      max-width: 720px;
      margin: 0 auto;
      padding: 0.45rem 0.8rem;
      border-radius: 8px;
      border: 1px solid rgba(194, 61, 61, 0.45);
      background: rgba(194, 61, 61, 0.1);
      color: #8e1f1f;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.35;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      font-family: inherit;
      color: var(--text);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }

    .btn:hover:not(:disabled) {
      background: var(--surface-alt);
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.btn-uploading {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.45rem;
      white-space: nowrap;
    }

    .btn.btn-uploading::before {
      content: "";
      position: static;
      width: 0.85rem;
      height: 0.85rem;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: btn-spin 0.8s linear infinite;
      flex: 0 0 auto;
    }

    @keyframes btn-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
      color: #fff;
    }

    .media-area {
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem 1.25rem;
      background: var(--bg);
      position: relative;
      z-index: 1;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      align-content: start;
    }

    .media-card {
      position: relative;
      background: var(--surface);
      border-radius: var(--media-radius);
      overflow: hidden;
      border: 1px solid rgba(26, 26, 26, 0.08);
      aspect-ratio: 3 / 4;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.12);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    .media-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 34px rgba(0, 0, 0, 0.17);
    }

    .media-card img,
    .media-card video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      display: block;
    }

    .media-card video {
      background: #000;
    }

    .media-card .media-link {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.5rem 0.6rem;
      background: rgba(26, 26, 26, 0.85);
      font-size: 0.75rem;
      font-weight: 500;
      text-align: center;
      color: #fff;
      text-decoration: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .media-card:hover .media-link {
      opacity: 1;
    }

    .media-link:hover {
      background: var(--accent);
    }

    .media-loading,
    .media-error,
    .media-empty {
      padding: 2rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.9375rem;
    }

    .media-error { color: var(--error); }

    .load-more {
      padding: 0.6rem 1.2rem;
      font-size: 0.875rem;
      font-weight: 600;
      font-family: inherit;
      color: var(--text);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }

    .load-more:hover:not(:disabled) {
      background: var(--accent-light);
      border-color: var(--accent);
      color: var(--accent);
    }

    .load-more:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .load-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      margin: 1rem 0;
    }

    /* —— Postcard groups (one postcard = one visit = 1+ images/videos) —— */
    .media-grid {
      display: block;
    }

    .postcard-group {
      margin-bottom: 1.5rem;
      padding: 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .postcard-group-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--accent-light);
    }

    .postcard-group-label .badge {
      font-weight: 500;
      color: var(--text-soft);
      background: var(--surface-alt);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }

    .postcard-group-media {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
      align-content: start;
    }

    .postcard-group-media .media-card {
      min-height: 0;
    }

    @media (max-width: 980px) {
      .postcard-group-media {
        grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      }
    }

    @media (max-width: 640px) {
      .postcard-group-media {
        grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
        gap: 0.75rem;
      }
      .media-card {
        border-radius: 18px;
      }
    }

    .postcard-group-footer {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .postcard-group-meta {
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
    }

    .postcard-group-meta .meta-row {
      display: inline-flex;
      align-items: baseline;
      gap: 0.25rem;
    }

    .postcard-group-meta .meta-label {
      font-weight: 600;
      color: var(--text-soft);
    }

    .postcard-group-meta .meta-value {
      color: var(--muted);
    }

    .postcard-group-meta .meta-row.meta-row-checkbox {
      align-items: center;
    }

    .postcard-group-meta .meta-row.meta-row-checkbox .meta-value {
      display: inline-flex;
      align-items: center;
    }

    .postcard-group-meta .meta-row.meta-row-checkbox input[type="checkbox"] {
      margin: 0;
      width: 0.9rem;
      height: 0.9rem;
      accent-color: var(--accent);
      cursor: default;
    }

    .postcard-group-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .postcard-group-actions .btn {
      padding: 0.4rem 0.75rem;
      font-size: 0.8125rem;
    }

    .footer-rail {
      position: sticky;
      bottom: 0;
      z-index: 35;
      background: var(--surface);
      border-top: 1px solid var(--border);
      box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
    }

    /* —— Pinned footer rail —— */
    .app-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0.8rem 1.25rem;
      background: var(--surface);
      border-top: none;
      box-shadow: none;
    }

    .footer-stats {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text);
    }

    .footer-stats .muted {
      font-weight: 500;
      color: var(--muted);
    }

    .footer-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .btn-mega {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 700;
      font-family: inherit;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
    }

    .btn-mega:hover:not(:disabled) {
      background: var(--accent-hover);
      box-shadow: var(--shadow-hover);
      transform: translateY(-1px);
    }

    .btn-mega:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .camera-info-bar {
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      gap: 0.75rem;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      scrollbar-width: thin;
      -webkit-overflow-scrolling: touch;
    }

    .camera-info-bar.hidden { display: none; }

    .camera-info-bar-footer {
      padding: 0.45rem 1rem 0.6rem;
      border-top: 1px solid var(--border);
      background: var(--surface);
      overflow: hidden;
    }

    .camera-card {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
      width: auto;
      text-align: left;
      padding: 0.4rem 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 999px;
      box-shadow: none;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s, transform 0.2s;
      color: var(--text);
      font-family: inherit;
      max-width: 260px;
      overflow: hidden;
    }

    .camera-card:hover {
      border-color: var(--accent);
      background: var(--accent-light);
      transform: translateY(-1px);
    }

    .camera-card.active {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }

    .camera-card .camera-title {
      font-size: 0.78rem;
      font-weight: 700;
      color: inherit;
      margin: 0;
      line-height: 1.15;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .camera-card .camera-meta {
      display: none;
    }

    .species-filter-bar {
      margin: 0;
      padding: 0.55rem 0.65rem;
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    .species-filter-bar.hidden { display: none; }

    .species-filter-bar .filter-label {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-soft);
      margin-right: 0.25rem;
    }

    .species-chip {
      display: inline-block;
      padding: 0.35rem 0.65rem;
      font-size: 0.8125rem;
      font-weight: 500;
      font-family: inherit;
      color: var(--text);
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }

    .species-chip:hover {
      background: var(--accent-light);
      border-color: var(--accent);
      color: var(--accent);
    }

    .species-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    @media (max-width: 980px) {
      .header-main {
        grid-template-columns: 1fr;
        gap: 0.55rem;
      }
      .header-status {
        text-align: left;
        padding: 0;
      }
      .header-actions {
        justify-content: flex-start;
      }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }
    .modal-overlay.hidden { display: none !important; }
    .modal {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      max-width: 96vw;
      width: 420px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
    }
    .modal-close {
      padding: 0.35rem 0.6rem;
      font-size: 1rem;
      line-height: 1;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
    }
    .modal-close:hover { color: var(--text); background: var(--surface-alt); }
    .modal-body {
      padding: 1rem 1.25rem;
    }
    .modal-body .modal-message {
      margin: 0 0 1rem;
      font-size: 0.9375rem;
      color: var(--text);
      line-height: 1.5;
    }
    .modal-body .modal-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .modal-body .modal-actions .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      font-family: inherit;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .modal-body .modal-actions .btn:hover { background: var(--accent-hover); }
  </style>
</head>
<body>
  <main id="loginScreen" class="screen">
    <h1 class="brand">GetBirds</h1>
    <p class="tagline">chirp chirp</p>
    <button type="button" id="loginBtn" class="login-btn">
      <svg viewBox="0 0 24 24">
        <path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Sign in with Google
    </button>
  </main>

  <main id="loggedInScreen" class="logged-in hidden">
    <header class="header">
      <div class="header-main">
        <div class="header-profile">
          <img id="avatar" class="avatar" src="" alt="" />
          <span class="header-title">GetBirds</span>
        </div>
        <div id="headerStatus" class="header-status" aria-live="polite"></div>
        <div class="header-actions">
          <button type="button" id="downloadAllBtn" class="btn btn-primary" hidden>Download all</button>
          <button type="button" id="signoutBtn" class="btn">Sign out</button>
        </div>
      </div>
      <div id="speciesFilterBar" class="species-filter-bar hidden" aria-label="Filter postcards"></div>
    </header>
    <div class="media-area">
      <div id="mediaGrid" class="media-grid"></div>
      <p id="mediaStatus" class="media-loading" hidden>Loading postcards…</p>
      <p id="mediaError" class="media-error" hidden></p>
      <p id="mediaEmpty" class="media-empty" hidden>No postcards yet.</p>
    </div>
    <div class="footer-rail">
      <footer id="appFooter" class="app-footer" aria-live="polite">
        <div class="footer-stats" id="footerStats">0 postcards displayed</div>
        <div class="footer-actions" id="footerActions">
          <button type="button" id="loadMoreBtn" class="load-more" hidden>Load more</button>
          <button type="button" id="loadAllBtn" class="load-more" hidden>Load all postcards</button>
          <button type="button" id="downloadAllMediaBtn" class="btn-mega" hidden>DOWNLOAD ALL MEDIA</button>
        </div>
      </footer>
      <div id="cameraInfoBar" class="camera-info-bar camera-info-bar-footer hidden" aria-label="BirdBuddy cameras"></div>
    </div>
  </main>

  <div id="youtubeUploadModalOverlay" class="modal-overlay hidden" aria-modal="true" aria-labelledby="youtubeModalTitle">
    <div class="modal">
      <div class="modal-header">
        <span id="youtubeModalTitle">YouTube</span>
        <button type="button" class="modal-close" id="youtubeModalClose" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <p id="youtubeModalMessage" class="modal-message"></p>
        <div class="modal-actions">
          <a id="youtubeModalOpenStudio" href="https://studio.youtube.com" target="_blank" rel="noopener" class="btn">Open YouTube Studio</a>
        </div>
      </div>
    </div>
  </div>

  <script>
(function () {
  "use strict";

  const CLIENT_ID = "1022751350446-o1m86gkguv2br1hfr1s2efau3aoj0jf2.apps.googleusercontent.com";
  /* Sign-in only: no restricted scopes so login does not get 403. */
  const SCOPE = "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";
  /* Requested only when user clicks Save to YouTube (incremental auth + playlist management). */
  const SCOPE_YOUTUBE = "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube";
  const USERINFO_URL = "https://openidconnect.googleapis.com/v1/userinfo";
  const REVOKE_URL = "https://oauth2.googleapis.com/revoke";
  const BB_GRAPHQL = "https://graphql.app-api.prod.aws.mybirdbuddy.com/graphql";
  const BB_GRAPHQL_OVERRIDE_KEY = "bb_graphql_override";
  const BB_GRAPHQL_OVERRIDE_QUERY_KEYS = ["bb_graphql", "bbGraphql", "graphql"];
  const BB_GRAPHQL_ALLOW_DIRECT_QUERY_KEYS = ["bb_graphql_direct", "bbGraphqlDirect"];

  const STORAGE_KEYS = {
    googleAccessToken: "google_access_token",
    googleExpiresAt: "google_expires_at",
    picture: "google_picture",
    name: "google_name",
    bbAccessToken: "bb_access_token",
    bbExpiresAt: "bb_expires_at",
    bbRefreshToken: "bb_refresh_token",
    youtubeUploadBlockedUntil: "youtube_upload_blocked_until",
    youtubeUploadBlockedReason: "youtube_upload_blocked_reason"
  };

  /* BirdBuddy token considered stale this many ms before expiry (refresh proactively). */
  const BB_TOKEN_STALE_MS = 2 * 60 * 1000;
  const UNKNOWN_SPECIES_LABEL = "Unknown Birdo";
  const SPECIES_FILTER_IDENTIFIED = "Identified only";
  const SPECIES_FILTER_NOT_COLLECTED = "__not_collected__";
  const LEGACY_SPECIES_FILTER_UNKNOWN = "Unknown";

  function isUnknownSpeciesLabel(name) {
    var s = String(name || "").trim().toLowerCase();
    if (!s) return false;
    return s === "unknown" ||
      s === "unknown birdo" ||
      s === "unidentified" ||
      s === "unrecognized" ||
      s === "n/a" ||
      s === "na" ||
      s === "none";
  }

  function canonicalizeSpeciesLabel(name) {
    var s = String(name || "").trim();
    if (!s) return "";
    return isUnknownSpeciesLabel(s) ? UNKNOWN_SPECIES_LABEL : s;
  }

  /* Feed query variants: rich species first, assigned-name fallback, then no-species fallback. */
  var INBOX_FEED_QUERY = [
    'query inboxFeed($first: Int, $after: String, $filter: FeedFilterInput) {',
    '  me {',
    '    feed(first: $first, after: $after, filter: $filter) {',
    '      edges { cursor node {',
    '        __typename',
    '        ... on FeedItemNewPostcard { id createdAt expiresAt medias { __typename id thumbnailUrl ... on MediaImage { contentUrl(size: ORIGINAL) } ... on MediaVideo { contentUrl(size: ORIGINAL) } } mediaSpeciesAssignedName { name species { id name scientificName } } sightingReportPreview { sightings { __typename ... on SightingRecognizedBird { species { __typename ... on SpeciesBird { id name scientificName } ... on SpeciesBirdFamily { id name } ... on SpeciesBirdGenus { id name } ... on SpeciesBirdOrder { id name } } } ... on SightingRecognizedBirdUnlocked { species { __typename ... on SpeciesBird { id name scientificName } ... on SpeciesBirdFamily { id name } ... on SpeciesBirdGenus { id name } ... on SpeciesBirdOrder { id name } } } } } }',
    '        ... on FeedItemCollectedPostcard { id createdAt expiresAt medias { __typename id thumbnailUrl ... on MediaImage { contentUrl(size: ORIGINAL) } ... on MediaVideo { contentUrl(size: ORIGINAL) } } mediaSpeciesAssignedName { name species { id name scientificName } } species { id name scientificName } }',
    '      } }',
    '      pageInfo { hasNextPage endCursor }',
    '    }',
    '  }',
    '}'
  ].join(' ');

  var INBOX_FEED_QUERY_BIRDS = [
    'query inboxFeed($first: Int, $after: String, $filter: FeedFilterInput) {',
    '  me {',
    '    feed(first: $first, after: $after, filter: $filter) {',
    '      edges { cursor node {',
    '        __typename',
    '        ... on FeedItemNewPostcard { id createdAt expiresAt medias { __typename id thumbnailUrl ... on MediaImage { contentUrl(size: ORIGINAL) } ... on MediaVideo { contentUrl(size: ORIGINAL) } } mediaSpeciesAssignedName { name species { id name scientificName } } }',
    '        ... on FeedItemCollectedPostcard { id createdAt expiresAt medias { __typename id thumbnailUrl ... on MediaImage { contentUrl(size: ORIGINAL) } ... on MediaVideo { contentUrl(size: ORIGINAL) } } mediaSpeciesAssignedName { name species { id name scientificName } } species { id name scientificName } }',
    '      } }',
    '      pageInfo { hasNextPage endCursor }',
    '    }',
    '  }',
    '}'
  ].join(' ');

  var INBOX_FEED_QUERY_NO_SPECIES = [
    'query inboxFeed($first: Int, $after: String, $filter: FeedFilterInput) {',
    '  me {',
    '    feed(first: $first, after: $after, filter: $filter) {',
    '      edges { cursor node {',
    '        __typename',
    '        ... on FeedItemNewPostcard { id createdAt expiresAt medias { __typename id thumbnailUrl ... on MediaImage { contentUrl(size: ORIGINAL) } ... on MediaVideo { contentUrl(size: ORIGINAL) } } }',
    '        ... on FeedItemCollectedPostcard { id createdAt expiresAt medias { __typename id thumbnailUrl ... on MediaImage { contentUrl(size: ORIGINAL) } ... on MediaVideo { contentUrl(size: ORIGINAL) } } }',
    '      } }',
    '      pageInfo { hasNextPage endCursor }',
    '    }',
    '  }',
    '}'
  ].join(' ');

  const $ = function (id) { return document.getElementById(id); };
  const loginScreen = $("loginScreen");
  const loggedInScreen = $("loggedInScreen");
  const loginBtn = $("loginBtn");
  const avatar = $("avatar");
  const signoutBtn = $("signoutBtn");
  const mediaGrid = $("mediaGrid");
  const mediaStatus = $("mediaStatus");
  const mediaError = $("mediaError");
  const mediaEmpty = $("mediaEmpty");
  const loadMoreBtn = $("loadMoreBtn");
  const loadAllBtn = $("loadAllBtn");
  const downloadAllBtn = $("downloadAllBtn");
  const appFooter = $("appFooter");
  const footerStats = $("footerStats");
  const footerActions = $("footerActions");
  const downloadAllMediaBtn = $("downloadAllMediaBtn");
  const cameraInfoBar = $("cameraInfoBar");
  const speciesFilterBar = $("speciesFilterBar");
  const headerStatus = $("headerStatus");
  const youtubeUploadModalOverlay = $("youtubeUploadModalOverlay");
  const youtubeModalMessage = $("youtubeModalMessage");
  const youtubeModalClose = $("youtubeModalClose");
  const youtubeModalOpenStudio = $("youtubeModalOpenStudio");

  var headerStatusTimer = null;
  var HEADER_STATUS_EXPIRY_MS = 5000;

  function setHeaderStatus(msg, isError, opts) {
    opts = opts || {};
    if (!headerStatus) return;
    if (headerStatusTimer) {
      clearTimeout(headerStatusTimer);
      headerStatusTimer = null;
    }
    headerStatus.textContent = msg || "";
    headerStatus.classList.toggle("error", !!isError);
    headerStatus.classList.toggle("youtube-limit", !!opts.youtubeLimit);
    headerStatus.style.display = msg ? "block" : "none";
    if (msg && !opts.persist) {
      headerStatusTimer = setTimeout(function () {
        if (isYouTubeUploadBlocked()) {
          setHeaderStatus(getYouTubeUploadBlockedMessage(), true, { persist: true, youtubeLimit: true });
          return;
        }
        headerStatus.textContent = "";
        headerStatus.classList.remove("error");
        headerStatus.classList.remove("youtube-limit");
        headerStatus.style.display = "none";
        headerStatusTimer = null;
      }, HEADER_STATUS_EXPIRY_MS);
    } else if (!msg) {
      headerStatus.classList.remove("youtube-limit");
    }
  }

  let busy = false;
  let tokenClient = null;
  let youtubeTokenClient = null;
  var pendingYouTubeUploadRequest = null;
  var activeYouTubeUploadButton = null;
  var activeYouTubeUploadButtonLabel = "";
  var youtubeUploadBlockedUntilMs = 0;
  var youtubeUploadBlockedReason = "";
  var youtubeUploadBlockedTimer = null;
  let loadMoreCursor = null;
  let hasMore = false;
  let activeVideo = null;
  var allPostcards = [];
  var allCameras = [];
  var cameraFilter = "All";
  var speciesFilter = null;
  var speciesQueryMode = "species";
  var deferSpeciesFilterRefresh = false;
  var speciesFilterRefreshPending = false;

  function parseRetryAfterSeconds(retryAfterValue) {
    var raw = String(retryAfterValue || "").trim();
    if (!raw) return 0;
    if (/^\d+$/.test(raw)) {
      var n = parseInt(raw, 10);
      return isFinite(n) && n > 0 ? n : 0;
    }
    var dt = Date.parse(raw);
    if (!isFinite(dt)) return 0;
    var sec = Math.ceil((dt - Date.now()) / 1000);
    return sec > 0 ? sec : 0;
  }

  function parseDurationHintSeconds(message) {
    var text = String(message || "");
    var match = text.match(/(?:in|after)\s+(\d+)\s*(second|minute|hour|day)s?/i);
    if (!match) return 0;
    var amount = parseInt(match[1], 10);
    if (!isFinite(amount) || amount <= 0) return 0;
    var unit = String(match[2] || "").toLowerCase();
    if (unit === "day") return amount * 86400;
    if (unit === "hour") return amount * 3600;
    if (unit === "minute") return amount * 60;
    return amount;
  }

  function formatDateTimeLocal(tsMs) {
    if (!tsMs || !isFinite(tsMs)) return "";
    var d = new Date(tsMs);
    if (isNaN(d.getTime())) return "";
    return d.toLocaleString(undefined, {
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "numeric",
      minute: "2-digit"
    });
  }

  function isYouTubeUploadLimitReason(reason) {
    var r = String(reason || "").toLowerCase();
    return r === "uploadlimitexceeded" ||
      r === "dailylimitexceeded" ||
      r === "dailylimitexceededunreg" ||
      r === "quotaexceeded" ||
      r === "userratelimitexceeded";
  }

  function isYouTubeUploadLimitError(err) {
    if (!err) return false;
    if (isYouTubeUploadLimitReason(err.youtubeReason)) return true;
    var msg = String(err.message || "").toLowerCase();
    return /uploadlimitexceeded|dailylimitexceeded|quotaexceeded|userratelimitexceeded|exceeded the number of videos/i.test(msg);
  }

  function computeYouTubeUploadBlockedUntilMs(err) {
    var retryAfterSec = err && typeof err.retryAfterSeconds === "number" ? err.retryAfterSeconds : 0;
    if (retryAfterSec > 0) return Date.now() + retryAfterSec * 1000;
    var hintedSec = parseDurationHintSeconds(err && err.message);
    if (hintedSec > 0) return Date.now() + hintedSec * 1000;
    if (err && String(err.youtubeReason || "").toLowerCase() === "dailylimitexceeded") {
      var midnight = new Date();
      midnight.setHours(24, 0, 0, 0);
      return midnight.getTime();
    }
    return Date.now() + 24 * 60 * 60 * 1000;
  }

  function extractYouTubeReasonFromText(text) {
    var t = String(text || "");
    var m = t.match(/\[reason:\s*([^\]]+)\]/i);
    if (m && m[1]) return String(m[1]).trim();
    return "";
  }

  function getYouTubeUploadBlockedMessage() {
    var reason = extractYouTubeReasonFromText(youtubeUploadBlockedReason);
    if (!youtubeUploadBlockedUntilMs) {
      return reason
        ? "No more Save to YouTube right now. YouTube limit hit (" + reason + ")."
        : "No more Save to YouTube right now. YouTube upload limit reached.";
    }
    var when = formatDateTimeLocal(youtubeUploadBlockedUntilMs);
    if (!when) {
      return reason
        ? "No more Save to YouTube right now. YouTube limit hit (" + reason + ")."
        : "No more Save to YouTube right now. YouTube upload limit reached.";
    }
    return reason
      ? "No more Save to YouTube until about " + when + " (" + reason + ")."
      : "No more Save to YouTube until about " + when + ".";
  }

  function isYouTubeUploadBlocked() {
    if (!youtubeUploadBlockedUntilMs) return false;
    if (Date.now() >= youtubeUploadBlockedUntilMs) {
      if (youtubeUploadBlockedTimer) {
        clearTimeout(youtubeUploadBlockedTimer);
        youtubeUploadBlockedTimer = null;
      }
      youtubeUploadBlockedUntilMs = 0;
      youtubeUploadBlockedReason = "";
      localStorage.removeItem(STORAGE_KEYS.youtubeUploadBlockedUntil);
      localStorage.removeItem(STORAGE_KEYS.youtubeUploadBlockedReason);
      return false;
    }
    return true;
  }

  function applyYouTubeUploadBlockedUi() {
    var blocked = isYouTubeUploadBlocked();
    var msg = blocked ? getYouTubeUploadBlockedMessage() : "";
    mediaGrid.querySelectorAll("button[data-save-youtube-button='true']").forEach(function (btn) {
      var hasVideo = btn.getAttribute("data-has-video") === "true";
      if (!hasVideo) {
        btn.disabled = true;
        btn.setAttribute("aria-disabled", "true");
        btn.title = "No MP4 video available in this postcard.";
        return;
      }
      if (blocked) {
        btn.disabled = true;
        btn.setAttribute("aria-disabled", "true");
        btn.title = msg;
      } else if (!btn.classList.contains("btn-uploading")) {
        btn.disabled = false;
        btn.removeAttribute("aria-disabled");
        btn.title = "";
      }
    });
    if (blocked) {
      setHeaderStatus(msg, true, { persist: true, youtubeLimit: true });
    } else if (headerStatus && headerStatus.classList.contains("youtube-limit")) {
      setHeaderStatus("", false);
    }
  }

  function scheduleYouTubeUploadBlockedUiRefresh() {
    if (youtubeUploadBlockedTimer) {
      clearTimeout(youtubeUploadBlockedTimer);
      youtubeUploadBlockedTimer = null;
    }
    if (!isYouTubeUploadBlocked()) return;
    var delay = youtubeUploadBlockedUntilMs - Date.now() + 250;
    if (!isFinite(delay) || delay < 500) delay = 500;
    if (delay > 2147483647) delay = 2147483647;
    youtubeUploadBlockedTimer = setTimeout(function () {
      youtubeUploadBlockedTimer = null;
      applyYouTubeUploadBlockedUi();
      if (isYouTubeUploadBlocked()) scheduleYouTubeUploadBlockedUiRefresh();
    }, delay);
  }

  function blockYouTubeUploadsUntil(untilMs, reason) {
    var next = Number(untilMs) || 0;
    if (!isFinite(next) || next <= Date.now()) next = Date.now() + 24 * 60 * 60 * 1000;
    youtubeUploadBlockedUntilMs = next;
    youtubeUploadBlockedReason = String(reason || "").trim();
    localStorage.setItem(STORAGE_KEYS.youtubeUploadBlockedUntil, String(youtubeUploadBlockedUntilMs));
    if (youtubeUploadBlockedReason) {
      localStorage.setItem(STORAGE_KEYS.youtubeUploadBlockedReason, youtubeUploadBlockedReason);
    } else {
      localStorage.removeItem(STORAGE_KEYS.youtubeUploadBlockedReason);
    }
    applyYouTubeUploadBlockedUi();
    scheduleYouTubeUploadBlockedUiRefresh();
  }

  function restoreYouTubeUploadBlockedState() {
    var storedUntil = parseInt(localStorage.getItem(STORAGE_KEYS.youtubeUploadBlockedUntil) || "0", 10);
    youtubeUploadBlockedReason = String(localStorage.getItem(STORAGE_KEYS.youtubeUploadBlockedReason) || "");
    youtubeUploadBlockedUntilMs = isFinite(storedUntil) ? storedUntil : 0;
    if (!isYouTubeUploadBlocked()) {
      youtubeUploadBlockedUntilMs = 0;
      youtubeUploadBlockedReason = "";
      if (youtubeUploadBlockedTimer) {
        clearTimeout(youtubeUploadBlockedTimer);
        youtubeUploadBlockedTimer = null;
      }
    } else {
      scheduleYouTubeUploadBlockedUiRefresh();
    }
  }

  function setBusy(on) {
    busy = !!on;
    loginBtn.disabled = busy;
    signoutBtn.disabled = busy;
    if (downloadAllBtn) downloadAllBtn.disabled = busy;
    if (loadMoreBtn) loadMoreBtn.disabled = busy;
    if (loadAllBtn) loadAllBtn.disabled = busy;
    if (downloadAllMediaBtn) downloadAllMediaBtn.disabled = busy;
  }

  function isElementVisible(el) {
    return !!(el && !el.hidden && el.style.display !== "none");
  }

  function getDisplayedCounts() {
    var groups = mediaGrid.querySelectorAll(".postcard-group");
    var links = mediaGrid.querySelectorAll(".media-link");
    return { postcards: groups.length, media: links.length };
  }

  function getVisibleCounts() {
    var postcards = 0;
    var media = 0;
    mediaGrid.querySelectorAll(".postcard-group").forEach(function (group) {
      if (!isElementVisible(group)) return;
      postcards += 1;
      media += group.querySelectorAll(".media-link").length;
    });
    return { postcards: postcards, media: media };
  }

  function updateFooter() {
    refreshSpeciesFilterBar();
    var visible = getVisibleCounts();
    var total = getDisplayedCounts();
    if (footerStats) {
      footerStats.innerHTML = visible.postcards + " postcard" + (visible.postcards === 1 ? "" : "s") + " displayed" + (visible.media > 0 ? " <span class=\"muted\">(" + visible.media + " media)</span>" : "");
    }
    if (footerActions && loadMoreBtn && loadAllBtn && downloadAllMediaBtn) {
      if (hasMore) {
        loadMoreBtn.hidden = false;
        loadAllBtn.hidden = false;
        downloadAllMediaBtn.hidden = true;
      } else {
        loadMoreBtn.hidden = true;
        loadAllBtn.hidden = true;
        downloadAllMediaBtn.hidden = total.media === 0;
      }
    }
    if (downloadAllBtn) {
      downloadAllBtn.hidden = hasMore || total.media === 0;
    }
    refreshCameraInfoBar();
    applyYouTubeUploadBlockedUi();
  }

  function cameraDisplayName(camera) {
    if (!camera) return "Camera";
    var name = String(camera.name || "").trim();
    if (name) return name;
    var id = String(camera.id || "").trim();
    return id ? ("Camera " + id.slice(0, 8)) : "Camera";
  }

  function formatCameraLocation(camera) {
    if (!camera) return "—";
    var parts = [];
    if (camera.city) parts.push(camera.city);
    if (camera.country) parts.push(camera.country);
    if (parts.length === 0 && camera.region) parts.push(camera.region);
    return parts.length ? parts.join(", ") : "—";
  }

  function formatCameraSignal(camera) {
    if (!camera) return "—";
    var parts = [];
    if (camera.signalState) parts.push(camera.signalState);
    if (typeof camera.signalValue === "number") parts.push(camera.signalValue + " dBm");
    return parts.length ? parts.join(" · ") : "—";
  }

  function formatCameraBattery(camera) {
    if (!camera) return "—";
    var parts = [];
    if (typeof camera.batteryPercent === "number") parts.push(camera.batteryPercent + "%");
    if (camera.batteryState) parts.push(camera.batteryState);
    if (typeof camera.batteryCharging === "boolean") parts.push(camera.batteryCharging ? "charging" : "not charging");
    return parts.length ? parts.join(" · ") : "—";
  }

  function formatCameraBool(value) {
    if (typeof value !== "boolean") return "—";
    return value ? "Yes" : "No";
  }

  function cameraPostcardCount(cameraId) {
    var total = 0;
    if (!cameraId) return total;
    allPostcards.forEach(function (p) {
      if ((p.feederId || "") === cameraId) total += 1;
    });
    return total;
  }

  function buildCameraInfoBar() {
    if (!cameraInfoBar) return;
    if (!allCameras || allCameras.length === 0) {
      cameraInfoBar.classList.add("hidden");
      cameraInfoBar.innerHTML = "";
      return;
    }
    cameraInfoBar.classList.remove("hidden");
    cameraInfoBar.innerHTML = "";

    function addCard(title, metaLines, cameraId) {
      var card = document.createElement("button");
      card.type = "button";
      card.className = "camera-card" + ((cameraFilter === cameraId || (cameraId === "All" && cameraFilter === "All")) ? " active" : "");
      var titleEl = document.createElement("div");
      titleEl.className = "camera-title";
      titleEl.textContent = title;
      card.appendChild(titleEl);
      var tooltip = (metaLines || []).join(" | ").trim();
      if (tooltip) {
        card.title = tooltip;
        card.setAttribute("aria-label", title + " — " + tooltip);
      } else {
        card.setAttribute("aria-label", title);
      }
      card.addEventListener("click", function () {
        cameraFilter = cameraFilter === cameraId ? "All" : cameraId;
        updateFooter();
      });
      cameraInfoBar.appendChild(card);
    }

    var onlineCount = 0;
    allCameras.forEach(function (c) {
      if (String(c.state || "").toUpperCase() === "ONLINE") onlineCount += 1;
    });
    var visibleCounts = getVisibleCounts();
    var totalCounts = getDisplayedCounts();
    var postcardLine = visibleCounts.postcards + " postcard(s) displayed";
    if (totalCounts.postcards !== visibleCounts.postcards) {
      postcardLine += " of " + totalCounts.postcards + " loaded";
    }
    addCard("All cameras (" + allCameras.length + ")", [
      onlineCount + " online",
      postcardLine
    ], "All");

    allCameras.forEach(function (camera) {
      var lines = [];
      lines.push("Type: " + (camera.type || "—"));
      lines.push("State: " + (camera.state || "—"));
      lines.push("Housing/Version: " + (camera.housingType || "—") + " / " + (camera.version || "—"));
      lines.push("Location: " + formatCameraLocation(camera));
      if (typeof camera.latitude === "number" && typeof camera.longitude === "number") {
        lines.push("Coords: " + camera.latitude.toFixed(4) + ", " + camera.longitude.toFixed(4));
      }
      lines.push("Battery: " + formatCameraBattery(camera));
      lines.push("Signal: " + formatCameraSignal(camera));
      lines.push("Food: " + (camera.foodState || "—"));
      lines.push("Temp: " + (typeof camera.temperature === "number" ? (camera.temperature + "°") : "—"));
      if (camera.ownerName) lines.push("Owner: " + camera.ownerName);
      if (camera.livestreamAccessStatus) lines.push("Livestream access: " + camera.livestreamAccessStatus);
      if (camera.videoQuality || camera.cameraFieldOfView || camera.firmwareVersion) {
        lines.push("Video/FOV: " + (camera.videoQuality || "—") + " / " + (camera.cameraFieldOfView || "—"));
        lines.push("Firmware: " + (camera.firmwareVersion || "—") + " (avail " + (camera.availableFirmwareVersion || "—") + ")");
      }
      if (camera.serialNumber) lines.push("SN: " + camera.serialNumber);
      lines.push("Power/Frequency: " + (camera.powerProfile || "—") + " / " + (camera.frequency || "—"));
      lines.push("Audio enabled: " + formatCameraBool(camera.audioEnabled) + " · Off-grid: " + formatCameraBool(camera.offGrid));
      lines.push("Supports audio/Enhanced/WebRTC: " + formatCameraBool(camera.supportsAudio) + "/" + formatCameraBool(camera.supportsEnhancedLivestream) + "/" + formatCameraBool(camera.supportsWebRTC));
      if (camera.presenceUpdatedAt) lines.push("Presence: " + formatPostcardDate(camera.presenceUpdatedAt));
      if (typeof camera.invitationsAvailable === "number") lines.push("Invites available: " + camera.invitationsAvailable);
      lines.push("Postcards loaded: " + cameraPostcardCount(camera.id));
      addCard(cameraDisplayName(camera), lines, camera.id || "All");
    });
  }

  function refreshCameraInfoBar() {
    buildCameraInfoBar();
  }

  function normalizeCameraFromFeeder(feeder) {
    if (!feeder || typeof feeder !== "object") return null;
    var location = feeder.location || {};
    var battery = feeder.battery || {};
    var signal = feeder.signal || {};
    var food = feeder.food || {};
    var temperature = feeder.temperature || {};
    return {
      id: feeder.id ? String(feeder.id) : "",
      type: feeder.__typename ? String(feeder.__typename) : "",
      name: feeder.name ? String(feeder.name) : "",
      state: feeder.state ? String(feeder.state) : "",
      housingType: feeder.housingType ? String(feeder.housingType) : "",
      version: feeder.version ? String(feeder.version) : "",
      ownerName: feeder.ownerName ? String(feeder.ownerName) : "",
      livestreamAccessStatus: feeder.livestreamAccessStatus ? String(feeder.livestreamAccessStatus) : "",
      city: (location.city || feeder.locationCity || "").toString(),
      country: (location.country || feeder.locationCountry || "").toString(),
      region: (location.region || "").toString(),
      latitude: typeof location.latitude === "number" ? location.latitude : null,
      longitude: typeof location.longitude === "number" ? location.longitude : null,
      batteryState: battery.state ? String(battery.state) : "",
      batteryPercent: typeof battery.percentage === "number" ? battery.percentage : null,
      batteryCharging: typeof battery.charging === "boolean" ? battery.charging : null,
      signalState: signal.state ? String(signal.state) : "",
      signalValue: typeof signal.value === "number" ? signal.value : null,
      foodState: food.state ? String(food.state) : "",
      temperature: typeof temperature.value === "number" ? temperature.value : null,
      supportsAudio: typeof feeder.supportsAudio === "boolean" ? feeder.supportsAudio : null,
      supportsEnhancedLivestream: typeof feeder.supportsEnhancedLivestream === "boolean" ? feeder.supportsEnhancedLivestream : null,
      supportsWebRTC: typeof feeder.supportsWebRTC === "boolean" ? feeder.supportsWebRTC : null,
      firmwareVersion: feeder.firmwareVersion ? String(feeder.firmwareVersion) : "",
      availableFirmwareVersion: feeder.availableFirmwareVersion ? String(feeder.availableFirmwareVersion) : "",
      serialNumber: feeder.serialNumber ? String(feeder.serialNumber) : "",
      videoQuality: feeder.videoQuality ? String(feeder.videoQuality) : "",
      cameraFieldOfView: feeder.cameraFieldOfView ? String(feeder.cameraFieldOfView) : "",
      powerProfile: feeder.powerProfile ? String(feeder.powerProfile) : "",
      frequency: feeder.frequency ? String(feeder.frequency) : "",
      offGrid: typeof feeder.offGrid === "boolean" ? feeder.offGrid : null,
      audioEnabled: typeof feeder.audioEnabled === "boolean" ? feeder.audioEnabled : null,
      presenceUpdatedAt: feeder.presenceUpdatedAt ? String(feeder.presenceUpdatedAt) : "",
      invitationsAvailable: typeof feeder.invitationsAvailable === "number" ? feeder.invitationsAvailable : null
    };
  }

  function extractCamerasFromMeData(data) {
    var feeders = data && data.data && data.data.me && data.data.me.feeders;
    if (!Array.isArray(feeders)) return [];
    var out = [];
    var seen = {};
    feeders.forEach(function (feeder) {
      var camera = normalizeCameraFromFeeder(feeder);
      if (!camera || !camera.id) return;
      if (seen[camera.id]) return;
      seen[camera.id] = true;
      out.push(camera);
    });
    return out;
  }

  function applyCameraInventoryFromMeData(data) {
    var cameras = extractCamerasFromMeData(data);
    allCameras = cameras;
    if (!cameras.length) {
      cameraFilter = "All";
      refreshCameraInfoBar();
      applySpeciesFilter();
      return;
    }
    var exists = false;
    cameras.forEach(function (c) {
      if (c.id === cameraFilter) exists = true;
    });
    if (cameraFilter === "All" || !exists) {
      cameraFilter = cameras[0].id || "All";
    }
    refreshCameraInfoBar();
    applySpeciesFilter();
  }

  function refreshSpeciesFilterBar() {
    if (!speciesFilterBar) return;
    if (deferSpeciesFilterRefresh) {
      speciesFilterRefreshPending = true;
      return;
    }
    speciesFilterRefreshPending = false;
    buildSpeciesFilterBar();
    applySpeciesFilter();
  }

  function getUniqueSpecies() {
    var set = {};
    allPostcards.forEach(function (p) {
      var label = formatSpeciesLabel(p);
      set[label] = true;
    });
    return Object.keys(set).sort();
  }

  function applySpeciesFilter() {
    if (!mediaGrid) return;
    var groups = mediaGrid.querySelectorAll(".postcard-group");
    var visibleCount = 0;
    groups.forEach(function (el) {
      var dataSpecies = (el.getAttribute("data-species") || "").trim();
      var dataCameraId = (el.getAttribute("data-camera-id") || "").trim();
      var dataCollected = (el.getAttribute("data-collected") || "") === "1";
      var show = true;
      if (speciesFilter === null || speciesFilter === "All") {
        show = true;
      } else if (speciesFilter === SPECIES_FILTER_NOT_COLLECTED) {
        show = !dataCollected;
      } else if (speciesFilter === SPECIES_FILTER_IDENTIFIED) {
        show = dataSpecies !== "" && !isUnknownSpeciesLabel(dataSpecies);
      } else if (speciesFilter === LEGACY_SPECIES_FILTER_UNKNOWN || isUnknownSpeciesLabel(speciesFilter)) {
        show = dataSpecies === "" || isUnknownSpeciesLabel(dataSpecies);
      } else {
        show = dataSpecies.split(/\s*,\s*/).indexOf(speciesFilter) !== -1;
      }
      if (show && cameraFilter !== "All") {
        show = dataCameraId === "" || dataCameraId === cameraFilter;
      }
      el.style.display = show ? "" : "none";
      if (show) visibleCount += 1;
    });
    if (mediaEmpty && allPostcards.length > 0) {
      if (visibleCount === 0) {
        mediaEmpty.hidden = false;
        mediaEmpty.textContent = "No postcards match the active filters.";
      } else if (mediaEmpty.textContent === "No postcards match the active filters.") {
        mediaEmpty.hidden = true;
      }
    }
  }

  function buildSpeciesFilterBar() {
    if (!speciesFilterBar) return;
    if (speciesFilter === LEGACY_SPECIES_FILTER_UNKNOWN) speciesFilter = UNKNOWN_SPECIES_LABEL;
    if (allPostcards.length === 0) {
      speciesFilterBar.classList.add("hidden");
      speciesFilterBar.innerHTML = "";
      return;
    }
    speciesFilterBar.classList.remove("hidden");
    var unique = getUniqueSpecies();
    speciesFilterBar.innerHTML = "";
    var label = document.createElement("span");
    label.className = "filter-label";
    label.textContent = "Filter:";
    speciesFilterBar.appendChild(label);
    function addChip(text, value) {
      var chip = document.createElement("button");
      chip.type = "button";
      var isAll = value === "All";
      var isActive = isAll ? (speciesFilter === null || speciesFilter === "All") : (speciesFilter === value);
      chip.className = "species-chip" + (isActive ? " active" : "");
      chip.textContent = text;
      chip.dataset.filter = value;
      chip.addEventListener("click", function () {
        speciesFilter = speciesFilter === value ? "All" : value;
        updateFooter();
      });
      speciesFilterBar.appendChild(chip);
    }
    var notCollectedCount = 0;
    allPostcards.forEach(function (p) {
      if (!isPostcardCollected(p)) notCollectedCount += 1;
    });
    addChip("All", "All");
    addChip("Not Collected (" + notCollectedCount + ")", SPECIES_FILTER_NOT_COLLECTED);
    var hasUnknown = unique.some(function (name) { return isUnknownSpeciesLabel(name); });
    if (hasUnknown) {
      addChip(SPECIES_FILTER_IDENTIFIED, SPECIES_FILTER_IDENTIFIED);
      addChip(UNKNOWN_SPECIES_LABEL, UNKNOWN_SPECIES_LABEL);
    }
    unique.forEach(function (name) {
      if (isUnknownSpeciesLabel(name)) return;
      addChip(name, name);
    });
  }

  function updateDownloadAllVisibility() {
    updateFooter();
  }

  function resetLoggedInUI() {
    setHeaderStatus("", false);
    allPostcards = [];
    allCameras = [];
    cameraFilter = "All";
    speciesFilter = null;
    speciesQueryMode = "species";
    if (cameraInfoBar) {
      cameraInfoBar.innerHTML = "";
      cameraInfoBar.classList.add("hidden");
    }
    if (speciesFilterBar) speciesFilterBar.innerHTML = "";
    if (mediaGrid) mediaGrid.innerHTML = "";
    loadMoreCursor = null;
    hasMore = false;
    if (mediaStatus) {
      mediaStatus.hidden = true;
      mediaStatus.textContent = "";
    }
    if (mediaError) {
      mediaError.hidden = true;
      mediaError.textContent = "";
    }
    if (mediaEmpty) mediaEmpty.hidden = true;
    if (loadMoreBtn) loadMoreBtn.hidden = true;
    if (loadAllBtn) loadAllBtn.hidden = true;
    if (downloadAllMediaBtn) downloadAllMediaBtn.hidden = true;
    if (downloadAllBtn) downloadAllBtn.hidden = true;
    if (footerStats) footerStats.textContent = "0 postcards displayed";
    updateFooter();
  }

  function showLogin() {
    resetLoggedInUI();
    if (loggedInScreen) loggedInScreen.classList.add("hidden");
    if (loginScreen) loginScreen.classList.remove("hidden");
  }

  function showLoggedIn(profile) {
    loginScreen.classList.add("hidden");
    loggedInScreen.classList.remove("hidden");
    avatar.src = profile.picture || "";
    avatar.alt = profile.name ? "Profile: " + profile.name : "Profile";
    mediaGrid.innerHTML = "";
    loadMoreCursor = null;
    hasMore = false;
    loadMoreBtn.hidden = true;
    loadAllBtn.hidden = true;
    if (downloadAllMediaBtn) downloadAllMediaBtn.hidden = true;
    mediaStatus.hidden = false;
    mediaStatus.textContent = "Loading postcards…";
    mediaError.hidden = true;
    mediaEmpty.hidden = true;
    updateFooter();
    fetchBirdBuddyFeed();
  }

  function normalizeGraphqlEndpoint(urlLike) {
    var raw = String(urlLike || "").trim();
    if (!raw) return "";
    try {
      return new URL(raw, window.location.origin).toString();
    } catch (_) {
      return "";
    }
  }

  function syncGraphqlOverrideFromUrl() {
    try {
      var params = new URLSearchParams(window.location.search || "");
      if (params.has("bb_graphql_clear")) {
        localStorage.removeItem(BB_GRAPHQL_OVERRIDE_KEY);
        return;
      }
      for (var i = 0; i < BB_GRAPHQL_OVERRIDE_QUERY_KEYS.length; i++) {
        var key = BB_GRAPHQL_OVERRIDE_QUERY_KEYS[i];
        var candidate = normalizeGraphqlEndpoint(params.get(key));
        if (candidate) {
          localStorage.setItem(BB_GRAPHQL_OVERRIDE_KEY, candidate);
          return;
        }
      }
    } catch (_) {}
  }

  function isLocalDevOrigin() {
    try {
      var host = String(window.location.hostname || "").toLowerCase();
      return host === "localhost" ||
        host === "127.0.0.1" ||
        host === "::1" ||
        host === "[::1]" ||
        /\.local$/.test(host);
    } catch (_) {
      return false;
    }
  }

  function isDirectBirdBuddyEndpointUrl(urlLike) {
    try {
      var parsed = new URL(String(urlLike || ""), window.location.origin);
      var host = String(parsed.hostname || "").toLowerCase();
      return host === "graphql.app-api.prod.aws.mybirdbuddy.com";
    } catch (_) {
      return false;
    }
  }

  function shouldAllowDirectBirdBuddyGraphql() {
    try {
      if (window.__GBIRDS_ALLOW_DIRECT_BB_GRAPHQL === true) return true;
      var params = new URLSearchParams(window.location.search || "");
      for (var i = 0; i < BB_GRAPHQL_ALLOW_DIRECT_QUERY_KEYS.length; i++) {
        var key = BB_GRAPHQL_ALLOW_DIRECT_QUERY_KEYS[i];
        var value = (params.get(key) || "").trim().toLowerCase();
        if (value === "1" || value === "true" || value === "yes") return true;
      }
    } catch (_) {}
    return !isLocalDevOrigin();
  }

  function getGraphqlEndpointCandidates() {
    var out = [];
    var allowDirect = shouldAllowDirectBirdBuddyGraphql();
    function push(urlLike) {
      var u = normalizeGraphqlEndpoint(urlLike);
      if (!u) return;
      if (!allowDirect && isDirectBirdBuddyEndpointUrl(u)) return;
      if (out.indexOf(u) !== -1) return;
      out.push(u);
    }

    var injected = normalizeGraphqlEndpoint(window.__GBIRDS_GRAPHQL_ENDPOINT || window.__BB_GRAPHQL_ENDPOINT || "");
    var override = normalizeGraphqlEndpoint(localStorage.getItem(BB_GRAPHQL_OVERRIDE_KEY) || "");

    if (injected) push(injected);
    if (override) push(override);
    if (allowDirect) push(BB_GRAPHQL);
    return out;
  }

  function isRetryableGraphqlEndpointStatus(status) {
    return status === 400 ||
      status === 403 ||
      status === 404 ||
      status === 405 ||
      status === 408 ||
      status === 429 ||
      status === 500 ||
      status === 502 ||
      status === 503 ||
      status === 504;
  }

  function makeGraphqlConnectivityError(cause, attemptedEndpoints) {
    var details = attemptedEndpoints && attemptedEndpoints.length ? (" Tried: " + attemptedEndpoints.join(", ")) : "";
    var guidance = "Could not reach BirdBuddy GraphQL from this page origin. Use ?bb_graphql=<proxy-url> or window.__GBIRDS_GRAPHQL_ENDPOINT to force a proxy endpoint.";
    if (!shouldAllowDirectBirdBuddyGraphql()) {
      guidance += " Direct BirdBuddy GraphQL is disabled on localhost to avoid CORS preflight failures.";
    }
    var err = new Error(guidance + details);
    err.isNetworkError = true;
    err.isCorsError = true;
    if (cause) err.cause = cause;
    return err;
  }

  function bbGraphql(body, token) {
    var headers = {
      "Content-Type": "application/json",
      "Accept": "application/json"
    };
    if (token) headers["Authorization"] = "Bearer " + token;

    var payload = JSON.stringify(body);
    var endpoints = getGraphqlEndpointCandidates();
    var attempted = [];
    var lastErr = null;

    function tryEndpoint(i) {
      if (i >= endpoints.length) {
        return Promise.reject(makeGraphqlConnectivityError(lastErr, attempted));
      }
      var endpoint = endpoints[i];
      attempted.push(endpoint);
      return fetch(endpoint, {
        method: "POST",
        headers: headers,
        body: payload
      }).then(function (r) {
        if (r.status === 401) {
          var e = new Error("Unauthorized");
          e.isAuthError = true;
          return Promise.reject(e);
        }
        if (isRetryableGraphqlEndpointStatus(r.status) && i < endpoints.length - 1) {
          return tryEndpoint(i + 1);
        }
        return r;
      }).catch(function (e) {
        if (e && e.isAuthError) return Promise.reject(e);
        lastErr = e;
        if (i < endpoints.length - 1 && isCORSOrNetworkError(e)) {
          return tryEndpoint(i + 1);
        }
        return Promise.reject(makeGraphqlConnectivityError(e, attempted));
      });
    }

    return tryEndpoint(0);
  }

  function isBirdBuddyAuthError(code, message) {
    if (!code && !message) return false;
    var msg = (message || "").toUpperCase();
    return code === "UNAUTHENTICATED" ||
           code === "AUTH_TOKEN_EXPIRED_ERROR" ||
           /UNAUTHORIZED|INVALID TOKEN|TOKEN EXPIRED|AUTH_TOKEN_EXPIRED/i.test(msg);
  }

  function decodeBase64Url(input) {
    var base = String(input || "").replace(/-/g, "+").replace(/_/g, "/");
    while (base.length % 4) base += "=";
    return atob(base);
  }

  function parseJwtPayload(token) {
    try {
      var raw = String(token || "");
      var parts = raw.split(".");
      if (parts.length < 2) return null;
      return JSON.parse(decodeBase64Url(parts[1]));
    } catch (_) {
      return null;
    }
  }

  function getTokenExpiryMsFromJwt(token) {
    var payload = parseJwtPayload(token);
    if (!payload || typeof payload.exp !== "number") return 0;
    return payload.exp * 1000;
  }

  function resolveBbExpiryMs(token) {
    var jwtExp = getTokenExpiryMsFromJwt(token);
    if (jwtExp && jwtExp > Date.now()) return jwtExp;
    return Date.now() + 10 * 60 * 1000;
  }

  var POSTCARD_COLLECT_MUTATION = [
    "mutation postcardCollect($feedItemId: ID!, $postcardCollectInput: PostcardCollectInput) {",
    "  postcardCollect(feedItemId: $feedItemId, input: $postcardCollectInput) {",
    "    postcardCollectedDetails {",
    "      collectedPostcard { id __typename medias { id __typename } }",
    "      __typename",
    "    }",
    "    __typename",
    "  }",
    "}"
  ].join(" ");

  var POSTCARD_COLLECT_NO_INPUT_MUTATION = [
    "mutation postcardCollect($feedItemId: ID!) {",
    "  postcardCollect(feedItemId: $feedItemId) {",
    "    postcardCollectedDetails {",
    "      collectedPostcard { id __typename medias { id __typename } }",
    "      __typename",
    "    }",
    "    __typename",
    "  }",
    "}"
  ].join(" ");

  var LEGACY_COLLECT_POSTCARD_MUTATION = [
    "mutation collectPostcard($feedItemId: ID!) {",
    "  collectPostcard(feedItemId: $feedItemId) { __typename }",
    "}"
  ].join(" ");

  function getGraphqlErrorMessage(data, response) {
    if (data && data.errors && data.errors.length) {
      return data.errors[0].message || "Save to collection failed";
    }
    if (data && data.message) return data.message;
    if (response && response.status === 400) return "Bad request (400).";
    if (response && response.status) return "Save to collection failed (" + response.status + ")";
    return "Save to collection failed";
  }

  function isAlreadyCollectedError(msg) {
    return /already.*collect|already saved|already in collection/i.test(msg || "");
  }

  function normalizeCollectionErrorMessage(msg) {
    var text = String(msg || "");
    if (!text) return "Save to collection failed";
    if (/youtube\.thumbnail|custom video thumbnails/i.test(text)) {
      return "Save to collection is hitting a non-BirdBuddy endpoint. Clear any bb_graphql override and retry.";
    }
    return text;
  }

  function shouldFallbackCollectMutation(msg) {
    if (!msg) return false;
    return /Cannot query field\s+\"?postcardCollect\"?/i.test(msg) ||
           /Unknown argument\s+\"?input\"?\s+on field\s+\"?postcardCollect\"?/i.test(msg) ||
           /Unknown type\s+\"?PostcardCollectInput\"?/i.test(msg) ||
           /Cannot query field\s+\"?postcardCollectedDetails\"?/i.test(msg) ||
           /Unknown operation named\s+\"?postcardCollect\"?/i.test(msg);
  }

  function extractCollectedPostcardFromCollectResponse(data) {
    var root = data && data.data;
    if (!root || typeof root !== "object") return null;
    var details = root.postcardCollect && root.postcardCollect.postcardCollectedDetails;
    if (details && details.collectedPostcard) return details.collectedPostcard;
    return null;
  }

  function collectPostcardInBirdBuddy(postcard) {
    var feedItemId = postcard && postcard.id ? String(postcard.id) : "";
    if (!feedItemId) return Promise.reject(new Error("Postcard ID missing"));
    var bbToken = localStorage.getItem(STORAGE_KEYS.bbAccessToken);
    if (!bbToken) return Promise.reject(new Error("Not signed in to GetBirds"));

    var shareToCommunity = postcardHasKnownSpecies(postcard);
    var attempts = [
      {
        request: {
          operationName: "postcardCollect",
          variables: { feedItemId: feedItemId, postcardCollectInput: { share: shareToCommunity } },
          query: POSTCARD_COLLECT_MUTATION
        },
        allowFallback: true
      },
      {
        request: {
          operationName: "postcardCollect",
          variables: { feedItemId: feedItemId },
          query: POSTCARD_COLLECT_NO_INPUT_MUTATION
        },
        allowFallback: true
      },
      {
        request: {
          operationName: "collectPostcard",
          variables: { feedItemId: feedItemId },
          query: LEGACY_COLLECT_POSTCARD_MUTATION
        },
        allowFallback: false
      }
    ];

    function executeAttempt(index, lastMsg) {
      if (index >= attempts.length) {
        return Promise.reject(new Error(lastMsg || "Save to collection failed"));
      }
      var attempt = attempts[index];
      return bbGraphql(attempt.request, bbToken).then(function (r) {
        return r.json().catch(function () { return {}; }).then(function (data) {
          var collected = extractCollectedPostcardFromCollectResponse(data);
          var errMsg = "";
          if (data && data.errors && data.errors.length) errMsg = data.errors[0].message || "";
          if (!errMsg && !r.ok) errMsg = getGraphqlErrorMessage(data, r);
          if (collected) {
            var savedMediaCountFromCollected = Array.isArray(collected.medias)
              ? collected.medias.length
              : (Array.isArray(postcard && postcard.medias) ? postcard.medias.length : 0);
            return {
              alreadyCollected: isAlreadyCollectedError(errMsg),
              collectedPostcard: collected,
              savedMediaCount: savedMediaCountFromCollected,
              shareToCommunity: shareToCommunity
            };
          }
          if (errMsg) {
            if (isAlreadyCollectedError(errMsg)) {
              return {
                alreadyCollected: true,
                collectedPostcard: extractCollectedPostcardFromCollectResponse(data),
                savedMediaCount: Array.isArray(postcard && postcard.medias) ? postcard.medias.length : 0,
                shareToCommunity: shareToCommunity
              };
            }
            if (attempt.allowFallback && shouldFallbackCollectMutation(errMsg) && index < attempts.length - 1) {
              var fallbackErr = new Error(errMsg);
              fallbackErr.tryNextMutation = true;
              throw fallbackErr;
            }
            throw new Error(normalizeCollectionErrorMessage(errMsg));
          }
          var savedMediaCount = collected && Array.isArray(collected.medias)
            ? collected.medias.length
            : (Array.isArray(postcard && postcard.medias) ? postcard.medias.length : 0);
          return {
            alreadyCollected: false,
            collectedPostcard: collected,
            savedMediaCount: savedMediaCount,
            shareToCommunity: shareToCommunity
          };
        });
      }).catch(function (e) {
        var msg = normalizeCollectionErrorMessage(e && e.message ? e.message : "Save to collection failed");
        if (attempt.allowFallback && index < attempts.length - 1 &&
            ((e && e.tryNextMutation) || shouldFallbackCollectMutation(msg))) {
          return executeAttempt(index + 1, msg);
        }
        return Promise.reject(new Error(msg));
      });
    }

    return executeAttempt(0, "");
  }

  function authBirdBuddy(googleToken) {
    return bbGraphql({
      operationName: "authSocialSignIn",
      variables: { socialSignInInput: { token: googleToken, provider: "GOOGLE" } },
      query: "mutation authSocialSignIn($socialSignInInput: SocialSignInInput!) { authSocialSignIn(socialSignInInput: $socialSignInInput) { ... on Auth { accessToken refreshToken me { user { id __typename } feeders { ... on FeederForOwner { id __typename } __typename } __typename } } } }"
    }, null).then(function (r) { return r.json(); })
      .then(function (data) {
        var auth = data.data && data.data.authSocialSignIn;
        if (!auth || !auth.accessToken) {
          var err = (data.errors && data.errors[0] && data.errors[0].message) || "GetBirds sign-in failed";
          throw new Error(err);
        }
        var exp = resolveBbExpiryMs(auth.accessToken);
        localStorage.setItem(STORAGE_KEYS.bbAccessToken, auth.accessToken);
        localStorage.setItem(STORAGE_KEYS.bbExpiresAt, String(exp));
        if (auth.refreshToken) localStorage.setItem(STORAGE_KEYS.bbRefreshToken, auth.refreshToken);
        return auth.accessToken;
      });
  }

  var ME_QUERY = [
    "query me {",
    "  me {",
    "    user { id name __typename }",
    "    feeders {",
    "      __typename",
    "      ... on FeederForMember {",
    "        id name state housingType version ownerName locationCity locationCountry livestreamAccessStatus",
    "        supportsAudio supportsEnhancedLivestream supportsWebRTC",
    "        battery { charging percentage state __typename }",
    "        signal { state value __typename }",
    "        food { state __typename }",
    "        temperature { value __typename }",
    "      }",
    "      ... on FeederForOwner {",
    "        id name state housingType version",
    "        firmwareVersion availableFirmwareVersion",
    "        serialNumber videoQuality cameraFieldOfView",
    "        powerProfile frequency offGrid audioEnabled",
    "        supportsAudio supportsEnhancedLivestream supportsWebRTC",
    "        battery { charging percentage state __typename }",
    "        signal { state value __typename }",
    "        food { state __typename }",
    "        temperature { value __typename }",
    "        location { city country region latitude longitude __typename }",
    "        presenceUpdatedAt invitationsAvailable",
    "      }",
    "      ... on FeederForMemberPending { id name __typename }",
    "    }",
    "    __typename",
    "  }",
    "}"
  ].join(" ");

  var ME_QUERY_BASIC = "query me { me { user { id __typename } feeders { __typename ... on FeederForMember { id name __typename } ... on FeederForOwner { id name __typename } ... on FeederForMemberPending { id name __typename } } __typename } }";

  function runMeQuery(bbToken, query) {
    return bbGraphql({
      operationName: "me",
      variables: {},
      query: query
    }, bbToken).then(function (r) { return r.json(); }).then(function (data) {
      if (data.errors && data.errors.length) {
        var err = data.errors[0];
        var msg = err.message || "";
        var code = err.extensions && err.extensions.code;
        var e = new Error(msg);
        e.isAuthError = isBirdBuddyAuthError(code, msg);
        e.looksLikeSchemaError = /Cannot query field|Unknown field|FieldUndefined|Unknown type/i.test(msg);
        return Promise.reject(e);
      }
      return data;
    });
  }

  function fetchMe(bbToken) {
    return runMeQuery(bbToken, ME_QUERY).catch(function (e) {
      if (e && e.looksLikeSchemaError) {
        return runMeQuery(bbToken, ME_QUERY_BASIC);
      }
      return Promise.reject(e);
    });
  }

  function selectInboxFeedQuery(speciesMode) {
    var mode = speciesMode;
    if (mode === undefined || mode === true) mode = "species";
    if (mode === false) mode = "none";
    if (mode === "birds") return INBOX_FEED_QUERY_BIRDS;
    if (mode === "none") return INBOX_FEED_QUERY_NO_SPECIES;
    return INBOX_FEED_QUERY;
  }

  function isSpeciesSchemaError(msg) {
    msg = msg || "";
    return /Cannot query field\s+\"?(species|birds|commonName|scientificName|mediaSpeciesAssignedName|sightingReportPreview|sightings)\"?/i.test(msg) ||
           /Unknown field.*(species|birds|commonName|scientificName|mediaSpeciesAssignedName|sightingReportPreview|sightings)/i.test(msg) ||
           /FieldUndefined.*(species|birds|commonName|scientificName|mediaSpeciesAssignedName|sightingReportPreview|sightings)/i.test(msg) ||
           /Unknown type.*(SightingRecognizedBird|SightingRecognizedBirdUnlocked|SpeciesBird|SpeciesBirdFamily|SpeciesBirdGenus|SpeciesBirdOrder)/i.test(msg);
  }

  function fetchInboxFeed(bbToken, after, useFilter, speciesMode) {
    var variables = { first: 20 };
    if (after) variables.after = after;
    if (useFilter) variables.filter = { feedItemTypes: ["COLLECTED_POSTCARD", "NEW_POSTCARD"] };
    var query = selectInboxFeedQuery(speciesMode);
    return bbGraphql({
      operationName: "inboxFeed",
      variables: variables,
      query: query
    }, bbToken).then(function (r) { return r.json(); }).then(function (data) {
      if (data.errors && data.errors.length) {
        var err = data.errors[0];
        var msg = err.message || "";
        var code = err.extensions && err.extensions.code;
        var e = new Error(msg);
        e.isAuthError = isBirdBuddyAuthError(code, msg);
        e.isInternalError = code === "INTERNAL_SERVER_ERROR";
        e.retryWithFilter = !useFilter && e.isInternalError;
        e.looksLikeSpeciesFieldError = isSpeciesSchemaError(msg);
        return Promise.reject(e);
      }
      return data;
    });
  }

  function normalizeSpeciesName(value) {
    if (value == null) return "";
    if (typeof value === "string") return canonicalizeSpeciesLabel(value);
    if (typeof value !== "object") return "";
    if (value.commonName) return canonicalizeSpeciesLabel(value.commonName);
    if (value.name) return canonicalizeSpeciesLabel(value.name);
    if (value.label) return canonicalizeSpeciesLabel(value.label);
    if (value.scientificName) return canonicalizeSpeciesLabel(value.scientificName);
    if (value.species) return normalizeSpeciesName(value.species);
    return "";
  }

  function pushUniqueSpeciesName(out, value) {
    var name = normalizeSpeciesName(value);
    if (!name) return;
    var key = name.toLowerCase();
    for (var i = 0; i < out.length; i++) {
      if (String(out[i]).toLowerCase() === key) return;
    }
    out.push(name);
  }

  function extractSpeciesNames(node) {
    var out = [];
    if (!node) return out;

    var assigned = node.mediaSpeciesAssignedName;
    if (assigned) {
      pushUniqueSpeciesName(out, assigned);
      if (assigned.species) pushUniqueSpeciesName(out, assigned.species);
    }

    var s = node.species;
    if (s) {
      if (Array.isArray(s)) {
        s.forEach(function (x) {
          pushUniqueSpeciesName(out, x);
        });
      } else {
        pushUniqueSpeciesName(out, s);
      }
    }
    var b = node.birds;
    if (b) {
      if (Array.isArray(b)) {
        b.forEach(function (bird) {
          pushUniqueSpeciesName(out, bird);
          var sp = bird && bird.species;
          if (Array.isArray(sp)) {
            sp.forEach(function (x) { pushUniqueSpeciesName(out, x); });
          } else {
            pushUniqueSpeciesName(out, sp);
          }
        });
      } else {
        pushUniqueSpeciesName(out, b);
        if (Array.isArray(b.species)) {
          b.species.forEach(function (x) { pushUniqueSpeciesName(out, x); });
        } else {
          pushUniqueSpeciesName(out, b.species);
        }
      }
    }

    var preview = node.sightingReportPreview;
    var sightings = preview && preview.sightings;
    if (Array.isArray(sightings)) {
      sightings.forEach(function (sighting) {
        if (!sighting) return;
        pushUniqueSpeciesName(out, sighting.species);
      });
    }
    return out;
  }

  function fetchInboxFeedWithSpeciesFallback(bbToken, after, useFilter) {
    var modes = ["species", "birds", "none"];
    if (speciesQueryMode === "birds") modes = ["birds", "none"];
    if (speciesQueryMode === "none") modes = ["none"];
    var modeIndex = 0;

    function attempt(currentUseFilter) {
      var mode = modes[modeIndex];
      return fetchInboxFeed(bbToken, after, currentUseFilter, mode).then(function (data) {
        speciesQueryMode = mode;
        return data;
      }).catch(function (e) {
        if (e && e.retryWithFilter && !currentUseFilter) {
          return attempt(true);
        }
        if (e && e.looksLikeSpeciesFieldError && modeIndex < modes.length - 1) {
          modeIndex += 1;
          return attempt(currentUseFilter);
        }
        return Promise.reject(e);
      });
    }

    return attempt(!!useFilter);
  }

  function normalizePostcardFeeder(feeder) {
    if (!feeder || typeof feeder !== "object") return null;
    var location = feeder.location || {};
    return {
      id: feeder.id ? String(feeder.id) : "",
      name: feeder.name ? String(feeder.name) : "",
      type: feeder.__typename ? String(feeder.__typename) : "",
      housingType: feeder.housingType ? String(feeder.housingType) : "",
      version: feeder.version ? String(feeder.version) : "",
      city: (location.city || feeder.locationCity || "").toString(),
      country: (location.country || feeder.locationCountry || "").toString()
    };
  }

  function collectPostcardsFromFeed(data) {
    var postcards = [];
    var feed = data.data && data.data.me && data.data.me.feed;
    if (!feed || !feed.edges) return postcards;
    feed.edges.forEach(function (edge) {
      var node = edge.node;
      if (!node || !node.medias) return;
      var medias = [];
      node.medias.forEach(function (m, idx) {
        var url = m.contentUrl || m.thumbnailUrl;
        if (url) medias.push({
          url: url,
          thumb: m.thumbnailUrl,
          id: m.id,
          sourceIndex: idx,
          isVideo: m.__typename === "MediaVideo" || (!!m.contentUrl && m.contentUrl.indexOf(".mp4") !== -1)
        });
      });
      medias.reverse();
      var speciesNames = extractSpeciesNames(node);
      if (!speciesNames.length) speciesNames.push(UNKNOWN_SPECIES_LABEL);
      var feeder = normalizePostcardFeeder(node.feeder);
      if (medias.length) postcards.push({
        id: node.id,
        createdAt: node.createdAt,
        expiresAt: node.expiresAt,
        itemType: node.__typename || "",
        collected: node.__typename === "FeedItemCollectedPostcard",
        species: speciesNames,
        medias: medias,
        feeder: feeder,
        feederId: feeder && feeder.id ? feeder.id : ""
      });
    });
    return postcards;
  }

  function mediaSummary(medias) {
    var images = 0, videos = 0;
    medias.forEach(function (m) { if (m.isVideo) videos++; else images++; });
    var parts = [];
    if (images) parts.push(images + " photo" + (images === 1 ? "" : "s"));
    if (videos) parts.push(videos + " video" + (videos === 1 ? "" : "s"));
    return parts.length ? parts.join(", ") : "1 media";
  }

  function formatPostcardDate(value) {
    if (value == null || value === "") return "—";
    var d = new Date(value);
    return isNaN(d.getTime()) ? String(value) : d.toLocaleString(undefined, { dateStyle: "short", timeStyle: "short" });
  }

  function formatItemType(typename) {
    if (!typename) return "—";
    if (typename === "FeedItemNewPostcard") return "New postcard";
    if (typename === "FeedItemCollectedPostcard") return "Collected";
    return typename;
  }

  function getCanonicalSpeciesList(postcard) {
    var raw = postcard && Array.isArray(postcard.species) ? postcard.species : [];
    var out = [];
    var seen = {};
    for (var i = 0; i < raw.length; i++) {
      var s = canonicalizeSpeciesLabel(raw[i]);
      if (!s) continue;
      var key = s.toLowerCase();
      if (seen[key]) continue;
      seen[key] = true;
      out.push(s);
    }
    var known = out.filter(function (name) { return !isUnknownSpeciesLabel(name); });
    if (known.length) return known;
    if (out.length) return [UNKNOWN_SPECIES_LABEL];
    return [UNKNOWN_SPECIES_LABEL];
  }

  function formatSpeciesLabel(postcard) {
    if (!postcard) return "—";
    return getCanonicalSpeciesList(postcard).join(", ");
  }

  function postcardHasKnownSpecies(postcard) {
    return getCanonicalSpeciesList(postcard).some(function (name) {
      return !isUnknownSpeciesLabel(name);
    });
  }

  function isPostcardCollected(postcard) {
    return !!(postcard && (postcard.collected || postcard.itemType === "FeedItemCollectedPostcard"));
  }

  function md5HashString(input) {
    function cmn(q, a, b, x, s, t) {
      a = add32(add32(a, q), add32(x, t));
      return add32((a << s) | (a >>> (32 - s)), b);
    }
    function ff(a, b, c, d, x, s, t) { return cmn((b & c) | ((~b) & d), a, b, x, s, t); }
    function gg(a, b, c, d, x, s, t) { return cmn((b & d) | (c & (~d)), a, b, x, s, t); }
    function hh(a, b, c, d, x, s, t) { return cmn(b ^ c ^ d, a, b, x, s, t); }
    function ii(a, b, c, d, x, s, t) { return cmn(c ^ (b | (~d)), a, b, x, s, t); }
    function md5cycle(state, block) {
      var a = state[0], b = state[1], c = state[2], d = state[3];
      a = ff(a, b, c, d, block[0], 7, -680876936); d = ff(d, a, b, c, block[1], 12, -389564586);
      c = ff(c, d, a, b, block[2], 17, 606105819); b = ff(b, c, d, a, block[3], 22, -1044525330);
      a = ff(a, b, c, d, block[4], 7, -176418897); d = ff(d, a, b, c, block[5], 12, 1200080426);
      c = ff(c, d, a, b, block[6], 17, -1473231341); b = ff(b, c, d, a, block[7], 22, -45705983);
      a = ff(a, b, c, d, block[8], 7, 1770035416); d = ff(d, a, b, c, block[9], 12, -1958414417);
      c = ff(c, d, a, b, block[10], 17, -42063); b = ff(b, c, d, a, block[11], 22, -1990404162);
      a = ff(a, b, c, d, block[12], 7, 1804603682); d = ff(d, a, b, c, block[13], 12, -40341101);
      c = ff(c, d, a, b, block[14], 17, -1502002290); b = ff(b, c, d, a, block[15], 22, 1236535329);
      a = gg(a, b, c, d, block[1], 5, -165796510); d = gg(d, a, b, c, block[6], 9, -1069501632);
      c = gg(c, d, a, b, block[11], 14, 643717713); b = gg(b, c, d, a, block[0], 20, -373897302);
      a = gg(a, b, c, d, block[5], 5, -701558691); d = gg(d, a, b, c, block[10], 9, 38016083);
      c = gg(c, d, a, b, block[15], 14, -660478335); b = gg(b, c, d, a, block[4], 20, -405537848);
      a = gg(a, b, c, d, block[9], 5, 568446438); d = gg(d, a, b, c, block[14], 9, -1019803690);
      c = gg(c, d, a, b, block[3], 14, -187363961); b = gg(b, c, d, a, block[8], 20, 1163531501);
      a = gg(a, b, c, d, block[13], 5, -1444681467); d = gg(d, a, b, c, block[2], 9, -51403784);
      c = gg(c, d, a, b, block[7], 14, 1735328473); b = gg(b, c, d, a, block[12], 20, -1926607734);
      a = hh(a, b, c, d, block[5], 4, -378558); d = hh(d, a, b, c, block[8], 11, -2022574463);
      c = hh(c, d, a, b, block[11], 16, 1839030562); b = hh(b, c, d, a, block[14], 23, -35309556);
      a = hh(a, b, c, d, block[1], 4, -1530992060); d = hh(d, a, b, c, block[4], 11, 1272893353);
      c = hh(c, d, a, b, block[7], 16, -155497632); b = hh(b, c, d, a, block[10], 23, -1094730640);
      a = hh(a, b, c, d, block[13], 4, 681279174); d = hh(d, a, b, c, block[0], 11, -358537222);
      c = hh(c, d, a, b, block[3], 16, -722521979); b = hh(b, c, d, a, block[6], 23, 76029189);
      a = hh(a, b, c, d, block[9], 4, -640364487); d = hh(d, a, b, c, block[12], 11, -421815835);
      c = hh(c, d, a, b, block[15], 16, 530742520); b = hh(b, c, d, a, block[2], 23, -995338651);
      a = ii(a, b, c, d, block[0], 6, -198630844); d = ii(d, a, b, c, block[7], 10, 1126891415);
      c = ii(c, d, a, b, block[14], 15, -1416354905); b = ii(b, c, d, a, block[5], 21, -57434055);
      a = ii(a, b, c, d, block[12], 6, 1700485571); d = ii(d, a, b, c, block[3], 10, -1894986606);
      c = ii(c, d, a, b, block[10], 15, -1051523); b = ii(b, c, d, a, block[1], 21, -2054922799);
      a = ii(a, b, c, d, block[8], 6, 1873313359); d = ii(d, a, b, c, block[15], 10, -30611744);
      c = ii(c, d, a, b, block[6], 15, -1560198380); b = ii(b, c, d, a, block[13], 21, 1309151649);
      a = ii(a, b, c, d, block[4], 6, -145523070); d = ii(d, a, b, c, block[11], 10, -1120210379);
      c = ii(c, d, a, b, block[2], 15, 718787259); b = ii(b, c, d, a, block[9], 21, -343485551);
      state[0] = add32(a, state[0]); state[1] = add32(b, state[1]); state[2] = add32(c, state[2]); state[3] = add32(d, state[3]);
    }
    function md5blk(s, i) {
      return s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);
    }
    function md51(s) {
      var n = s.length;
      var state = [1732584193, -271733879, -1732584194, 271733878];
      var i;
      for (i = 64; i <= n; i += 64) {
        md5cycle(state, [
          md5blk(s, i - 64), md5blk(s, i - 60), md5blk(s, i - 56), md5blk(s, i - 52),
          md5blk(s, i - 48), md5blk(s, i - 44), md5blk(s, i - 40), md5blk(s, i - 36),
          md5blk(s, i - 32), md5blk(s, i - 28), md5blk(s, i - 24), md5blk(s, i - 20),
          md5blk(s, i - 16), md5blk(s, i - 12), md5blk(s, i - 8), md5blk(s, i - 4)
        ]);
      }
      s = s.slice(i - 64);
      var tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      for (i = 0; i < s.length; i++) tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);
      tail[i >> 2] |= 0x80 << ((i % 4) << 3);
      if (i > 55) {
        md5cycle(state, tail);
        for (i = 0; i < 16; i++) tail[i] = 0;
      }
      tail[14] = n * 8;
      md5cycle(state, tail);
      return state;
    }
    function rhex(n) {
      var hexChr = "0123456789abcdef";
      var s = "";
      var j;
      for (j = 0; j < 4; j++) {
        s += hexChr.charAt((n >> (j * 8 + 4)) & 0x0f) + hexChr.charAt((n >> (j * 8)) & 0x0f);
      }
      return s;
    }
    function add32(a, b) { return (a + b) & 0xffffffff; }
    var utf8 = unescape(encodeURIComponent(String(input || "")));
    var hash = md51(utf8);
    return rhex(hash[0]) + rhex(hash[1]) + rhex(hash[2]) + rhex(hash[3]);
  }

  function detectDownloadExtension(url, isVideo) {
    var fallback = isVideo ? ".mp4" : ".jpg";
    try {
      var pathname = new URL(String(url || "")).pathname || "";
      var base = pathname.split("/").filter(Boolean).pop() || "";
      var match = base.match(/\.([a-z0-9]{2,5})$/i);
      if (match && match[1]) return "." + match[1].toLowerCase();
    } catch (_) {}
    return fallback;
  }

  /** Always use dynamic hashed file names: file_<hash>.<ext>. */
  function filenameFromMedia(m) {
    var url = m && m.url ? String(m.url) : "";
    var ext = detectDownloadExtension(url, !!(m && m.isVideo));
    var hashSource = url || String((m && m.id) || "");
    var hash = md5HashString(hashSource || ("fallback-" + Date.now()));
    return "file_" + hash + ext;
  }

  function downloadMediaAsFile(url, filename) {
    if (!url) return Promise.reject(new Error("Missing media URL for download."));
    return fetch(url, { mode: "cors" })
      .then(function (res) {
        if (!res.ok) throw new Error("Download failed (" + res.status + ").");
        return res.blob();
      })
      .then(function (blob) {
        var objectUrl = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.style.display = "none";
        a.href = objectUrl;
        a.download = filename || ("file_" + md5HashString(url) + detectDownloadExtension(url, false));
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(function () { URL.revokeObjectURL(objectUrl); }, 15000);
      });
  }

  function getDownloadPayloadFromLink(link) {
    if (!link) return { url: "", filename: "" };
    var url = link.getAttribute("data-media-url") || link.href || "";
    var filename = link.getAttribute("download") || link.getAttribute("data-download-name") || "";
    if (!filename && url) {
      filename = "file_" + md5HashString(url) + detectDownloadExtension(url, /\.mp4|\.mov|\.webm/i.test(url));
    }
    return { url: url, filename: filename };
  }

  function triggerDownloadForLink(link) {
    var payload = getDownloadPayloadFromLink(link);
    if (!payload.url) return Promise.resolve();
    return downloadMediaAsFile(payload.url, payload.filename);
  }

  function setPostcardCollectedUi(postcardId, collected) {
    if (!postcardId) return;
    var isCollected = !!collected;
    for (var i = 0; i < allPostcards.length; i++) {
      var p = allPostcards[i];
      if (!p || p.id !== postcardId) continue;
      p.collected = isCollected;
      if (isCollected) p.itemType = "FeedItemCollectedPostcard";
    }
    mediaGrid.querySelectorAll(".postcard-group").forEach(function (group) {
      if ((group.getAttribute("data-postcard-id") || "") !== postcardId) return;
      group.setAttribute("data-collected", isCollected ? "1" : "0");
      var checkbox = group.querySelector("input[data-collected-indicator=\"true\"]");
      if (checkbox) checkbox.checked = isCollected;
      var saveBtn = group.querySelector("button[data-save-collection-button=\"true\"]");
      if (saveBtn) {
        saveBtn.classList.remove("btn-uploading");
        saveBtn.removeAttribute("aria-busy");
        saveBtn.disabled = isCollected;
        saveBtn.textContent = isCollected ? "Saved to collection" : "Save to collection";
      }
    });
    updateFooter();
  }

  function findCollectionSaveButton(postcardId) {
    if (!postcardId) return null;
    return mediaGrid.querySelector(
      ".postcard-group[data-postcard-id=\"" + String(postcardId).replace(/\"/g, "\\\"") + "\"] button[data-save-collection-button=\"true\"]"
    );
  }

  function setCollectionSaveButtonUploading(button, label) {
    if (!button) return;
    button.classList.add("btn-uploading");
    button.disabled = true;
    button.setAttribute("aria-busy", "true");
    button.textContent = label || "Saving…";
  }

  function resetCollectionSaveButton(button, postcard) {
    if (!button) return;
    var collected = isPostcardCollected(postcard);
    button.classList.remove("btn-uploading");
    button.removeAttribute("aria-busy");
    button.disabled = collected;
    button.textContent = collected ? "Saved to collection" : "Save to collection";
  }

  function appendPostcardGroups(postcards) {
    postcards.forEach(function (postcard) {
      allPostcards.push(postcard);
      var collectedState = isPostcardCollected(postcard);
      var wrap = document.createElement("div");
      wrap.className = "postcard-group";
      wrap.setAttribute("data-postcard-id", postcard.id || "");
      wrap.setAttribute("data-camera-id", postcard.feederId || "");
      wrap.setAttribute("data-collected", collectedState ? "1" : "0");
      var speciesStr = formatSpeciesLabel(postcard);
      wrap.setAttribute("data-species", speciesStr);
      var label = document.createElement("div");
      label.className = "postcard-group-label";
      label.textContent = speciesStr;
      var badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = mediaSummary(postcard.medias);
      label.appendChild(document.createTextNode(" "));
      label.appendChild(badge);
      wrap.appendChild(label);
      var grid = document.createElement("div");
      grid.className = "postcard-group-media";
      postcard.medias.forEach(function (m) {
        var card = document.createElement("div");
        card.className = "media-card";
        if (m.isVideo) {
          var v = document.createElement("video");
          v.src = m.url;
          v.controls = true;
          v.preload = "metadata";
          v.playsInline = true;
          v.addEventListener("play", function () {
            if (activeVideo && activeVideo !== v) activeVideo.pause();
            activeVideo = v;
          });
          v.addEventListener("pause", function () {
            if (activeVideo === v) activeVideo = null;
          });
          v.addEventListener("ended", function () {
            if (activeVideo === v) activeVideo = null;
          });
          card.appendChild(v);
        } else {
          var img = document.createElement("img");
          img.src = m.url;
          img.loading = "lazy";
          img.alt = "Postcard";
          card.appendChild(img);
        }
        var a = document.createElement("a");
        a.className = "media-link";
        a.href = m.url;
        a.download = filenameFromMedia(m);
        a.setAttribute("data-download-name", a.download);
        a.setAttribute("data-media-url", m.url);
        a.textContent = "Download " + (m.isVideo ? "MP4" : "JPG");
        a.addEventListener("click", function (ev) {
          ev.preventDefault();
          triggerDownloadForLink(a).catch(function (err) {
            setHeaderStatus((err && err.message) || "Download failed.", true);
          });
        });
        card.appendChild(a);
        grid.appendChild(card);
      });
      wrap.appendChild(grid);

      var footer = document.createElement("div");
      footer.className = "postcard-group-footer";
      var meta = document.createElement("div");
      meta.className = "postcard-group-meta";
      function metaRow(label, value) {
        var row = document.createElement("div");
        row.className = "meta-row";
        var lab = document.createElement("span");
        lab.className = "meta-label";
        lab.textContent = label + ": ";
        var val = document.createElement("span");
        val.className = "meta-value";
        val.textContent = value != null && value !== "" ? value : "—";
        row.appendChild(lab);
        row.appendChild(val);
        return row;
      }
      function metaCheckboxRow(label, checked, indicatorKey) {
        var row = document.createElement("div");
        row.className = "meta-row meta-row-checkbox";
        var lab = document.createElement("span");
        lab.className = "meta-label";
        lab.textContent = label + ": ";
        var val = document.createElement("span");
        val.className = "meta-value";
        var checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.disabled = true;
        checkbox.checked = !!checked;
        checkbox.setAttribute("aria-label", label);
        if (indicatorKey) checkbox.setAttribute(indicatorKey, "true");
        val.appendChild(checkbox);
        row.appendChild(lab);
        row.appendChild(val);
        return row;
      }
      meta.appendChild(metaRow("ID", postcard.id));
      if (postcard.feeder && postcard.feeder.name) {
        meta.appendChild(metaRow("Camera", postcard.feeder.name));
      }
      if (postcard.feeder && (postcard.feeder.city || postcard.feeder.country)) {
        meta.appendChild(metaRow("Location", formatCameraLocation(postcard.feeder)));
      }
      meta.appendChild(metaRow("Species", formatSpeciesLabel(postcard)));
      meta.appendChild(metaCheckboxRow("Collected", collectedState, "data-collected-indicator"));
      meta.appendChild(metaRow("Created", formatPostcardDate(postcard.createdAt)));
      meta.appendChild(metaRow("Expires", formatPostcardDate(postcard.expiresAt)));
      meta.appendChild(metaRow("Media", postcard.medias.length + " item" + (postcard.medias.length === 1 ? "" : "s")));
      footer.appendChild(meta);
      var actions = document.createElement("div");
      actions.className = "postcard-group-actions";
      var downloadPostcardBtn = document.createElement("button");
      downloadPostcardBtn.type = "button";
      downloadPostcardBtn.className = "btn";
      downloadPostcardBtn.textContent = "Download Postcard";
      downloadPostcardBtn.dataset.postcardId = postcard.id || "";
      downloadPostcardBtn.addEventListener("click", function () { onDownloadPostcard(postcard, downloadPostcardBtn); });
      var saveCollectionBtn = document.createElement("button");
      saveCollectionBtn.type = "button";
      saveCollectionBtn.className = "btn btn-primary";
      saveCollectionBtn.textContent = collectedState ? "Saved to collection" : "Save to collection";
      saveCollectionBtn.dataset.postcardId = postcard.id || "";
      saveCollectionBtn.dataset.itemType = postcard.itemType || "";
      saveCollectionBtn.setAttribute("data-save-collection-button", "true");
      saveCollectionBtn.disabled = collectedState;
      saveCollectionBtn.addEventListener("click", function () { onSaveToCollection(postcard, saveCollectionBtn); });
      var saveYoutubeBtn = document.createElement("button");
      var hasVideoMedia = postcardHasVideoMedia(postcard);
      saveYoutubeBtn.type = "button";
      saveYoutubeBtn.className = "btn";
      saveYoutubeBtn.textContent = "Save to YouTube";
      saveYoutubeBtn.dataset.postcardId = postcard.id || "";
      saveYoutubeBtn.setAttribute("data-save-youtube-button", "true");
      saveYoutubeBtn.setAttribute("data-has-video", hasVideoMedia ? "true" : "false");
      saveYoutubeBtn.disabled = !hasVideoMedia || isYouTubeUploadBlocked();
      if (!hasVideoMedia) {
        saveYoutubeBtn.setAttribute("aria-disabled", "true");
        saveYoutubeBtn.title = "No MP4 video available in this postcard.";
      } else if (isYouTubeUploadBlocked()) {
        saveYoutubeBtn.setAttribute("aria-disabled", "true");
        saveYoutubeBtn.title = getYouTubeUploadBlockedMessage();
      }
      saveYoutubeBtn.addEventListener("click", function () { onSaveToYouTube(postcard, saveYoutubeBtn); });
      actions.appendChild(downloadPostcardBtn);
      actions.appendChild(saveCollectionBtn);
      actions.appendChild(saveYoutubeBtn);
      footer.appendChild(actions);
      wrap.appendChild(footer);
      mediaGrid.appendChild(wrap);
    });
  }

  function fetchBirdBuddyFeed() {
    var googleToken = localStorage.getItem(STORAGE_KEYS.googleAccessToken);
    var bbToken = localStorage.getItem(STORAGE_KEYS.bbAccessToken);
    var bbExp = parseInt(localStorage.getItem(STORAGE_KEYS.bbExpiresAt) || "0", 10);
    if (!bbExp && bbToken) {
      bbExp = getTokenExpiryMsFromJwt(bbToken);
      if (bbExp) localStorage.setItem(STORAGE_KEYS.bbExpiresAt, String(bbExp));
    }

    function applyFeedResponse(data) {
      var postcards = collectPostcardsFromFeed(data);
      var feed = data.data && data.data.me && data.data.me.feed;
      var pageInfo = feed && feed.pageInfo;
      hasMore = !!(pageInfo && pageInfo.hasNextPage && pageInfo.endCursor);
      loadMoreCursor = pageInfo && pageInfo.endCursor ? pageInfo.endCursor : null;

      appendPostcardGroups(postcards);
      mediaStatus.hidden = true;
      if (postcards.length === 0 && !loadMoreCursor) {
        mediaEmpty.hidden = false;
      }
      if (hasMore) {
        loadMoreBtn.disabled = false;
        loadAllBtn.disabled = false;
      }
      updateFooter();
    }

    function doFetch(token) {
      return fetchMe(token).then(function (meData) {
        applyCameraInventoryFromMeData(meData);
        return fetchInboxFeedWithSpeciesFallback(token, loadMoreCursor, true);
      }).then(function (data) {
        applyFeedResponse(data);
      });
    }

    function runFeedFetch(useStoredToken) {
      if (useStoredToken && bbToken && bbExp && Date.now() < bbExp - BB_TOKEN_STALE_MS) {
        return doFetch(bbToken);
      }
      return authBirdBuddy(googleToken).then(function (accessToken) {
        return doFetch(accessToken);
      });
    }

    function isBbTokenFresh() {
      var token = localStorage.getItem(STORAGE_KEYS.bbAccessToken);
      var exp = parseInt(localStorage.getItem(STORAGE_KEYS.bbExpiresAt) || "0", 10);
      if (!exp && token) {
        exp = getTokenExpiryMsFromJwt(token);
        if (exp) localStorage.setItem(STORAGE_KEYS.bbExpiresAt, String(exp));
      }
      return !!(token && exp && Date.now() < exp - BB_TOKEN_STALE_MS);
    }

    function clearBirdBuddyTokens() {
      localStorage.removeItem(STORAGE_KEYS.bbAccessToken);
      localStorage.removeItem(STORAGE_KEYS.bbExpiresAt);
      localStorage.removeItem(STORAGE_KEYS.bbRefreshToken);
    }

    var isInitialLoad = loadMoreCursor === null;
    if (isInitialLoad) setBusy(true);
    loadMoreBtn.disabled = true;

    var p = runFeedFetch(isBbTokenFresh());

    return p.catch(function (e) {
      if (e && e.isAuthError && googleToken) {
        clearBirdBuddyTokens();
        return runFeedFetch(false);
      }
      return Promise.reject(e);
    }).then(function () {
      mediaError.hidden = true;
    }).catch(function (e) {
      mediaStatus.hidden = true;
      mediaError.hidden = false;
      mediaError.textContent = e.message || "Failed to load feed";
      if (e && (e.isCorsError || e.isNetworkError || (e.message && /CORS|Failed to fetch|ERR_FAILED|network/i.test(e.message)))) {
        mediaError.textContent += " Use ?bb_graphql=<proxy-url> or set window.__GBIRDS_GRAPHQL_ENDPOINT if you need a proxy endpoint.";
      }
    }).finally(function () {
      if (isInitialLoad) setBusy(false);
      loadMoreBtn.disabled = false;
    });
  }

  function loadAllPostcards() {
    return new Promise(function (resolve, reject) {
      if (!hasMore || busy) {
        resolve();
        return;
      }
      deferSpeciesFilterRefresh = true;
      speciesFilterRefreshPending = false;
      loadMoreBtn.hidden = true;
      loadAllBtn.hidden = true;
      mediaStatus.hidden = false;
      mediaStatus.textContent = "Loading all postcards…";
      function finishFilterRefresh() {
        deferSpeciesFilterRefresh = false;
        refreshSpeciesFilterBar();
      }
      function next() {
        if (!hasMore) {
          mediaStatus.hidden = true;
          loadMoreBtn.hidden = true;
          loadAllBtn.hidden = true;
          updateDownloadAllVisibility();
          finishFilterRefresh();
          resolve();
          return;
        }
        fetchBirdBuddyFeed().then(next).catch(function (e) {
          mediaStatus.hidden = true;
          loadMoreBtn.hidden = false;
          loadAllBtn.hidden = false;
          updateDownloadAllVisibility();
          finishFilterRefresh();
          reject(e);
        });
      }
      next();
    });
  }

  function triggerDownloadsSequentially(links, delayMs) {
    var list = Array.prototype.slice.call(links || []);
    if (list.length === 0) return Promise.resolve();
    delayMs = typeof delayMs === "number" ? delayMs : 400;
    var i = 0;
    var failed = 0;
    var firstError = null;
    function next() {
      if (i >= list.length) {
        if (failed > 0) {
          var msg = failed + " download" + (failed === 1 ? "" : "s") + " failed.";
          if (firstError && firstError.message) msg += " " + firstError.message;
          return Promise.reject(new Error(msg));
        }
        return Promise.resolve();
      }
      var link = list[i++];
      return triggerDownloadForLink(link).catch(function (err) {
        failed += 1;
        if (!firstError) firstError = err || new Error("Download failed.");
      }).then(function () {
        return waitMs(delayMs);
      }).then(next);
    }
    return next();
  }

  function triggerAllDownloads() {
    return triggerDownloadsSequentially(mediaGrid.querySelectorAll(".media-link"), 400);
  }

  function getMediaLinksForPostcard(postcardId) {
    var targetId = String(postcardId || "").trim();
    if (!targetId) return [];
    var links = [];
    mediaGrid.querySelectorAll(".postcard-group").forEach(function (group) {
      if ((group.getAttribute("data-postcard-id") || "") !== targetId) return;
      group.querySelectorAll(".media-link").forEach(function (a) {
        links.push(a);
      });
    });
    return links;
  }

  function triggerDownloadsForPostcard(postcard, delayMs) {
    var postcardId = postcard && postcard.id ? String(postcard.id) : "";
    if (!postcardId) return Promise.resolve();
    var links = getMediaLinksForPostcard(postcardId);
    if (!links.length) return Promise.resolve();
    return triggerDownloadsSequentially(links, delayMs || 350);
  }

  function setPostcardDownloadButtonUploading(button, label) {
    if (!button) return;
    button.classList.add("btn-uploading");
    button.disabled = true;
    button.setAttribute("aria-busy", "true");
    button.textContent = label || "Downloading…";
  }

  function resetPostcardDownloadButton(button) {
    if (!button) return;
    button.classList.remove("btn-uploading");
    button.disabled = false;
    button.removeAttribute("aria-busy");
    button.textContent = "Download Postcard";
  }

  function onDownloadPostcard(postcard, button) {
    if (!postcard || !postcard.id) return;
    if (busy) return;
    var links = getMediaLinksForPostcard(postcard.id);
    if (!links.length) {
      setHeaderStatus("No media in this postcard.", true);
      return;
    }
    setBusy(true);
    mediaError.hidden = true;
    mediaStatus.hidden = false;
    mediaStatus.textContent = "Downloading postcard media…";
    setPostcardDownloadButtonUploading(button, "Downloading…");
    triggerDownloadsForPostcard(postcard, 350)
      .then(function () {
        mediaStatus.hidden = true;
        setHeaderStatus("Download started for postcard media. Check your browser downloads.", false);
      })
      .catch(function (e) {
        mediaStatus.hidden = true;
        setHeaderStatus((e && e.message) || "Postcard download failed.", true);
      })
      .finally(function () {
        resetPostcardDownloadButton(button);
        setBusy(false);
      });
  }

  function onSaveToCollection(postcard, button) {
    if (!postcard || !postcard.id) return;
    var saveButton = button || findCollectionSaveButton(postcard.id);
    if (isPostcardCollected(postcard)) {
      setPostcardCollectedUi(postcard.id, true);
      setHeaderStatus("Already saved to collection.", false);
      return;
    }
    if (busy) return;
    setBusy(true);
    mediaError.hidden = true;
    mediaStatus.hidden = false;
    mediaStatus.textContent = "Saving postcard " + (postcard.id.slice(0, 8)) + "…";
    setCollectionSaveButtonUploading(saveButton, "Saving…");
    collectPostcardInBirdBuddy(postcard)
      .then(function (result) {
        setPostcardCollectedUi(postcard.id, true);
        postcard.collected = true;
        postcard.itemType = "FeedItemCollectedPostcard";
        mediaStatus.hidden = true;
        if (result && result.alreadyCollected) {
          setHeaderStatus("Already saved to collection.", false);
          return;
        }
        var savedCount = result && typeof result.savedMediaCount === "number"
          ? result.savedMediaCount
          : (Array.isArray(postcard.medias) ? postcard.medias.length : 0);
        var target = result && result.shareToCommunity
          ? "private + community collections"
          : "private catch-all collection";
        setHeaderStatus(
          "Saved " + savedCount + " media item" + (savedCount === 1 ? "" : "s") + " to " + target + ".",
          false
        );
      })
      .catch(function (e) {
        resetCollectionSaveButton(saveButton, postcard);
        mediaStatus.hidden = true;
        mediaError.hidden = true;
        setHeaderStatus(e.message || "Save to collection failed", true);
      })
      .finally(function () { setBusy(false); });
  }

  function getPrimarySpeciesForYouTube(postcard) {
    var list = getCanonicalSpeciesList(postcard);
    return list.length ? list[0] : UNKNOWN_SPECIES_LABEL;
  }

  function formatYouTubeTitleDate(value) {
    if (value == null || value === "") return "Unknown date";
    var d = new Date(value);
    if (isNaN(d.getTime())) return String(value);
    return d.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
  }

  function dedupeTagList(tags) {
    var out = [];
    var seen = {};
    (tags || []).forEach(function (tag) {
      var t = String(tag || "").trim();
      if (!t) return;
      var key = t.toLowerCase();
      if (seen[key]) return;
      seen[key] = true;
      out.push(t);
    });
    return out;
  }

  function getPostcardVideoMedia(postcard) {
    var medias = postcard && Array.isArray(postcard.medias) ? postcard.medias : [];
    return medias.filter(function (m) {
      return !!(m && m.isVideo && m.url);
    });
  }

  function postcardHasVideoMedia(postcard) {
    return getPostcardVideoMedia(postcard).length > 0;
  }

  function getMediaDownloadPath(m) {
    if (!m || !m.url) return "—";
    try {
      return new URL(m.url).toString();
    } catch (_) {
      return String(m.url);
    }
  }

  function clampYouTubeTitle(title) {
    var t = String(title || "");
    if (t.length <= 100) return t;
    return t.slice(0, 97) + "...";
  }

  function clampChars(text, maxChars) {
    var t = String(text || "").trim();
    if (maxChars <= 0) return "";
    if (t.length <= maxChars) return t;
    if (maxChars <= 3) return t.slice(0, maxChars);
    return t.slice(0, maxChars - 3).trimEnd() + "...";
  }

  function utf8ByteLength(text) {
    var value = String(text || "");
    if (typeof TextEncoder !== "undefined") {
      return new TextEncoder().encode(value).length;
    }
    try {
      return unescape(encodeURIComponent(value)).length;
    } catch (_) {
      return value.length;
    }
  }

  function clampUtf8Bytes(text, maxBytes) {
    var value = String(text || "");
    if (maxBytes <= 0) return "";
    if (utf8ByteLength(value) <= maxBytes) return value;
    var low = 0;
    var high = value.length;
    while (low < high) {
      var mid = Math.ceil((low + high) / 2);
      var candidate = value.slice(0, mid);
      if (utf8ByteLength(candidate) <= maxBytes) {
        low = mid;
      } else {
        high = mid - 1;
      }
    }
    return value.slice(0, low);
  }

  function sanitizeYouTubeTags(tags, maxTotalChars) {
    var cleaned = [];
    var seen = {};
    var total = 0;
    var limit = typeof maxTotalChars === "number" && maxTotalChars > 0 ? maxTotalChars : 500;
    (Array.isArray(tags) ? tags : []).forEach(function (tag) {
      var t = String(tag || "").replace(/[<>]/g, " ").replace(/\s+/g, " ").trim();
      if (!t) return;
      if (t.length > 60) t = t.slice(0, 60).trim();
      var key = t.toLowerCase();
      if (seen[key]) return;
      var extra = (cleaned.length ? 1 : 0) + t.length;
      if (total + extra > limit) return;
      seen[key] = true;
      cleaned.push(t);
      total += extra;
    });
    return cleaned;
  }

  function sanitizeYouTubeMetadata(metadata) {
    var m = metadata && typeof metadata === "object" ? metadata : {};
    var snippet = m.snippet && typeof m.snippet === "object" ? m.snippet : {};
    var status = m.status && typeof m.status === "object" ? m.status : {};
    var privacy = String(status.privacyStatus || "public").toLowerCase();
    if (privacy !== "public" && privacy !== "private" && privacy !== "unlisted") privacy = "public";
    var outSnippet = {
      title: clampYouTubeTitle(snippet.title || "GetBirds postcard")
    };
    var description = clampChars(snippet.description || "", 5000);
    description = clampUtf8Bytes(description, 5000).trim();
    if (description) outSnippet.description = description;
    var tags = sanitizeYouTubeTags(snippet.tags || [], 450);
    if (tags.length) outSnippet.tags = tags;
    outSnippet.categoryId = String(snippet.categoryId || "22").trim() || "22";
    var outStatus = {
      privacyStatus: privacy
    };
    if (typeof status.selfDeclaredMadeForKids === "boolean") {
      outStatus.selfDeclaredMadeForKids = status.selfDeclaredMadeForKids;
    }
    return {
      snippet: outSnippet,
      status: outStatus
    };
  }

  function buildYouTubeInsertMetadataAttempts(metadata) {
    var safe = sanitizeYouTubeMetadata(metadata);
    var attempts = [];
    attempts.push(safe);
    attempts.push({
      snippet: {
        title: safe.snippet.title,
        description: safe.snippet.description || "",
        categoryId: safe.snippet.categoryId || "22"
      },
      status: safe.status
    });
    attempts.push({
      snippet: {
        title: safe.snippet.title,
        categoryId: safe.snippet.categoryId || "22"
      },
      status: {
        privacyStatus: safe.status.privacyStatus
      }
    });
    attempts.push({
      snippet: {
        title: safe.snippet.title
      },
      status: {
        privacyStatus: safe.status.privacyStatus
      }
    });
    return attempts;
  }

  function buildCompactYouTubeMetadata(metadata) {
    var normalized = sanitizeYouTubeMetadata(metadata);
    var compact = {
      snippet: {
        title: clampYouTubeTitle(normalized.snippet.title || "GetBirds postcard")
      }
    };
    if (!compact.snippet.title) {
      compact.snippet.title = "GetBirds postcard";
    }
    return compact;
  }

  function buildUploadBootstrapMetadata(metadata) {
    var normalized = sanitizeYouTubeMetadata(metadata);
    return {
      snippet: {
        title: clampYouTubeTitle(normalized.snippet.title || "GetBirds postcard")
      }
    };
  }

  function buildUltraMinimalUploadMetadata(metadata) {
    var normalized = sanitizeYouTubeMetadata(metadata);
    return {
      snippet: {
        title: clampYouTubeTitle(normalized.snippet.title || "GetBirds postcard")
      }
    };
  }

  function buildPublishOnlyMetadata(metadata) {
    var normalized = sanitizeYouTubeMetadata(metadata);
    var out = {
      snippet: {
        title: clampYouTubeTitle(normalized.snippet.title || "GetBirds postcard"),
        categoryId: String(normalized.snippet.categoryId || "22")
      },
      status: {
        privacyStatus: String(normalized.status.privacyStatus || "public")
      }
    };
    if (typeof normalized.status.selfDeclaredMadeForKids === "boolean") {
      out.status.selfDeclaredMadeForKids = normalized.status.selfDeclaredMadeForKids;
    }
    return out;
  }

  function normalizeSpeciesListForYouTube(postcard) {
    return getCanonicalSpeciesList(postcard);
  }

  function pickPrimarySpeciesFromList(speciesList) {
    var list = Array.isArray(speciesList) ? speciesList : [];
    for (var i = 0; i < list.length; i++) {
      var s = canonicalizeSpeciesLabel(list[i]);
      if (s && !isUnknownSpeciesLabel(s)) return s;
    }
    return list.length ? canonicalizeSpeciesLabel(list[0]) || UNKNOWN_SPECIES_LABEL : UNKNOWN_SPECIES_LABEL;
  }

  function getSpeciesTriviaLine(speciesName) {
    var canonical = canonicalizeSpeciesLabel(speciesName);
    var key = canonical.toLowerCase();
    var triviaMap = {
      "northern flicker": "Northern Flickers are one of the few woodpeckers that forage on the ground for ants.",
      "house finch": "House Finches can signal local habitat quality through subtle shifts in plumage color.",
      "american robin": "American Robins can produce several broods in one season when food is abundant.",
      "downy woodpecker": "Downy Woodpeckers can cling to thin stems thanks to stiff tail feathers and zygodactyl feet.",
      "black-capped chickadee": "Black-capped Chickadees cache seeds and remember many hiding spots over long periods.",
      "european starling": "European Starlings can mimic sounds and coordinate in large murmurations."
    };
    if (triviaMap[key]) return triviaMap[key];
    if (isUnknownSpeciesLabel(canonical)) {
      return "Unknown sightings still reveal behavior patterns, weather effects, and feeding timing over time.";
    }
    return canonical + " sightings can expose repeatable feeding windows and behavior shifts across seasons.";
  }

  function seededIndex(seed, modulo, salt) {
    if (!modulo || modulo <= 0) return 0;
    var hash = md5HashString(String(seed || "") + "|" + String(salt || ""));
    var n = parseInt(hash.slice(0, 8), 16);
    if (!isFinite(n)) n = 0;
    return n % modulo;
  }

  function pickSeeded(list, seed, salt) {
    if (!Array.isArray(list) || list.length === 0) return "";
    return list[seededIndex(seed, list.length, salt)];
  }

  function formatNaturalList(items) {
    var out = [];
    for (var i = 0; i < (items || []).length; i++) {
      var t = canonicalizeSpeciesLabel(items[i]);
      if (!t) continue;
      out.push(t);
    }
    if (out.length === 0) return UNKNOWN_SPECIES_LABEL;
    if (out.length === 1) return out[0];
    if (out.length === 2) return out[0] + " and " + out[1];
    return out.slice(0, -1).join(", ") + ", and " + out[out.length - 1];
  }

  function getSpeciesFactLines(speciesName) {
    var canonical = canonicalizeSpeciesLabel(speciesName);
    var key = canonical.toLowerCase();
    var facts = {
      "house finch": [
        "Male House Finches usually get redder when their diet has more carotenoids, so color can hint at food quality.",
        "House Finches thrive around human neighborhoods but still shift feeder timing quickly when weather changes.",
        "Their song can be long and warbly, and individuals often remix phrases like tiny jazz vocalists."
      ],
      "brown-headed cowbird": [
        "Brown-Headed Cowbirds are brood parasites that lay eggs in other birds' nests instead of building their own.",
        "Cowbirds historically tracked grazing herds, taking advantage of insects disturbed by large mammals.",
        "Host species vary in how well they detect and reject cowbird eggs, shaping local nesting outcomes."
      ],
      "northern flicker": [
        "Northern Flickers are unusual woodpeckers because they often forage on the ground for ants.",
        "Their tongues are built for ant-heavy diets, and they can consume large numbers of insects in one day.",
        "Flickers flash bright underwing colors in flight, which can be useful for identification."
      ],
      "american robin": [
        "American Robins can raise multiple broods in one season when conditions are good.",
        "Robins often use visual cues to locate prey and can quickly exploit worm activity after rain.",
        "Even common robins show local behavior differences based on yard layout and predator pressure."
      ],
      "downy woodpecker": [
        "Downy Woodpeckers use stiff tail feathers and specialized feet to brace against bark.",
        "They often tap lightly while foraging, listening for insect movement beneath wood.",
        "Downies are small but persistent, and their winter feeder visits can become highly regular."
      ],
      "black-capped chickadee": [
        "Black-capped Chickadees cache seeds and remember many storage locations with remarkable accuracy.",
        "Chickadee call structure can encode predator risk, and flock members react to that detail.",
        "Their winter survival depends on rapid foraging decisions and social information sharing."
      ],
      "blue jay": [
        "Blue Jays cache acorns and can help move oak trees across landscapes over time.",
        "They use varied calls and can mimic other birds, adding complexity to backyard soundscapes.",
        "Jay social behavior can look dramatic, but much of it is strategic communication."
      ],
      "mourning dove": [
        "Mourning Doves can produce nutrient-rich crop milk to feed chicks.",
        "Their wing whistle at takeoff is caused by specialized feather structure.",
        "Doves often feed quickly on open ground and rely on fast escape behavior."
      ],
      "european starling": [
        "European Starlings can mimic sounds and perform highly coordinated flock maneuvers.",
        "Starling murmurations are shaped by local neighbor interactions and rapid response timing.",
        "Their iridescent plumage can look plain from one angle and metallic from another."
      ],
      "red-winged blackbird": [
        "Male Red-winged Blackbirds defend breeding territories aggressively during nesting season.",
        "Their iconic song is part display, part warning, and part territory map.",
        "Female Red-winged Blackbirds use cover and nest placement to reduce predation risk."
      ]
    };
    if (facts[key] && facts[key].length) return facts[key];
    if (isUnknownSpeciesLabel(canonical)) {
      return [
        "Unknown birds still provide real data through posture, feeding rhythm, flock spacing, and alarm responses.",
        "Mystery sightings are often resolved by combining behavior, silhouette, and repeat visits over time.",
        "In feeder ecology, uncertainty is useful: it highlights exactly what observations to capture next."
      ];
    }
    return [
      canonical + " can be profiled through feeder timing, posture, perch preference, and weather-linked activity shifts.",
      "Repeated sightings of " + canonical + " help separate random visits from true behavior patterns.",
      "Even one short clip of " + canonical + " can teach useful details about local habitat and food pressure."
    ];
  }

  function buildSpeciesScene(speciesName, createdTitleDate, seed, index) {
    var species = canonicalizeSpeciesLabel(speciesName) || UNKNOWN_SPECIES_LABEL;
    var facts = getSpeciesFactLines(species);
    var factA = facts[seededIndex(seed, facts.length, "fact-a-" + index)];
    var factB = facts[seededIndex(seed, facts.length, "fact-b-" + index + "-x")];
    if (factA === factB && facts.length > 1) {
      factB = facts[(seededIndex(seed, facts.length, "fact-b2-" + index) + 1) % facts.length];
    }
    var sceneOpeners = [
      "Scene " + (index + 1) + ": the camera catches " + species + " cannonballing into frame like a tiny superhero paid in sunflower seeds.",
      "Scene " + (index + 1) + ": " + species + " lands with Saturday-morning-cartoon confidence and zero concern for feeder traffic laws.",
      "Scene " + (index + 1) + ": " + species + " touches down, pauses, and delivers a dramatic head tilt worthy of an orchestra hit."
    ];
    var comedyTags = [
      "The seed tray reacts like it just heard a plot-twist trombone.",
      "Background extras blink twice and instantly form a suspiciously organized committee.",
      "Somewhere offscreen, a serious squirrel files a formal complaint and is politely ignored."
    ];
    var open = pickSeeded(sceneOpeners, seed, "scene-open-" + index);
    var comedy = pickSeeded(comedyTags, seed, "scene-comedy-" + index);
    if (isUnknownSpeciesLabel(species)) {
      return (
        open +
        " The species label is " + UNKNOWN_SPECIES_LABEL + ", which upgrades this episode into a mystery special nobody saw coming. " +
        factA + " " + factB + " " + comedy
      );
    }
    return open + " " + factA + " " + factB + " " + comedy;
  }

  function applyTemplatePlaceholders(text, speciesListLabel, createdTitleDate) {
    return String(text || "")
      .replace(/\{species\}/g, speciesListLabel)
      .replace(/\{date\}/g, createdTitleDate);
  }

  function expandDescriptionToNearLimit(baseText, seed, speciesListLabel, createdTitleDate) {
    var out = String(baseText || "").trim();
    var targetChars = 5000;
    var maxChars = 5000;
    var expansions = [
      "Cartoon-energy fact drop: birds may look chaotic, but feeder behavior is structured. Timing, perch choice, and peck order can signal dominance and risk tolerance in real time.",
      "The plot on {date} moves fast because HH5HH's GetBirds app is basically a turbo button for sorting and publishing, so @BirdsOfBroomfield can spend less time tapping menus and more time watching feathered theater.",
      "Science with giggles: {species} can be analyzed by feeding cadence, posture, and spacing from neighbors, and yes, that absolutely counts as educational entertainment.",
      "If this were a cartoon episode, this is the moment the brass section goes bananas while one bird steals center stage and another bird pretends it definitely meant to miss the landing.",
      "Ornithology note: repeated clips across days help separate random chance from true behavior patterns, especially when weather and light conditions shift.",
      "Viewer mission: track who arrives first, who gets displaced, and who quietly reroutes. That tiny choreography reveals more ecology than people expect.",
      "Every cut in this upload says the same thing: fast tooling matters. HH5HH's GetBirds flow keeps momentum high while the birds keep improvising nonsense at professional speed.",
      "Mildly ridiculous but true: one feeder can host strategy, comedy, and applied animal behavior in the same minute, which is why these uploads are both funny and useful.",
      "Unknown species moments are not failures. They are clues. Clues drive better observation, better ID, and better episodes the next time the mystery guest appears.",
      "Family-friendly chaos report: nobody swears, everyone snacks, and the drama still lands harder than most scripted TV.",
      "Education checkpoint: body shape, tail movement, and food handling often identify birds more reliably than one blurry color patch.",
      "Backyard lore update: if {species} had an agent, it would demand top billing, hazard pay, and first rights to the premium perch."
    ];
    var i = 0;
    while (out.length < targetChars && i < 80) {
      var add = pickSeeded(expansions, seed, "expand-" + i);
      add = applyTemplatePlaceholders(add, speciesListLabel, createdTitleDate);
      out += "\n\n" + add;
      i += 1;
    }
    return clampChars(out, maxChars);
  }

  function buildYouTubeLongDescription(postcard, speciesList, createdTitleDate) {
    var seed = (postcard && postcard.id) || (postcard && postcard.createdAt) || createdTitleDate || "getbirds";
    var list = Array.isArray(speciesList) && speciesList.length ? speciesList : [UNKNOWN_SPECIES_LABEL];
    var speciesListLabel = formatNaturalList(list);
    var openerTemplates = [
      "Cold open: @BirdsOfBroomfield on IG goes live at the feeder, {species} storms the stage on {date}, and HH5HH's GetBirds app rockets this from raw clips to publish-ready hilarity in record time.",
      "Welcome back to the seed-powered cartoon universe: {species} appears on {date}, @BirdsOfBroomfield captures the chaos, and HH5HH's GetBirds app turns it into a same-day wildlife blockbuster.",
      "Today in family-friendly feather mayhem: {species} enters frame on {date}, steals the spotlight, and GetBirds by HH5HH moves the whole episode from capture to upload before the snacks run out."
    ];
    var actOneTemplates = [
      "Act I - Setup. The camera catches micro-behaviors before humans finish guessing names: posture, spacing, and peck timing all hint at strategy.",
      "Act I - Establishing shot. The feeder looks peaceful for six seconds, then one confident landing rewrites neighborhood diplomacy.",
      "Act I - Opening tension. Perch positions and eye-lines expose social rank faster than any narrated documentary voice-over."
    ];
    var actTwoTemplates = [
      "Act II - Escalation. Comedy rises, but so does the science: behavior becomes evidence, and evidence sharpens identification.",
      "Act II - Momentum. Clip by clip, this turns into a lesson in foraging strategy, risk management, and social negotiation with bonus slapstick.",
      "Act II - Rising action. Every new arrival rewrites the script in real time, and the feeder becomes an improv stage with ornithology baked in."
    ];
    var finaleTemplates = [
      "Finale. Upload lands while the joke is still hot: quick workflow, high replay value, and one more episode in the backyard bird cinematic universe.",
      "Finale. Story shipped, facts intact, laughs secured, and the feeder cast is already rehearsing the sequel with no budget meetings required.",
      "Finale. Fast capture-to-publish means less button mashing and more wildlife storytelling people actually want to watch, share, and learn from."
    ];

    var paragraphs = [];
    paragraphs.push(applyTemplatePlaceholders(pickSeeded(openerTemplates, seed, "opener"), speciesListLabel, createdTitleDate));
    paragraphs.push(pickSeeded(actOneTemplates, seed, "act1"));
    paragraphs.push(pickSeeded(actTwoTemplates, seed, "act2"));

    for (var i = 0; i < list.length; i++) {
      paragraphs.push(buildSpeciesScene(list[i], createdTitleDate, seed, i));
    }

    var primarySpecies = pickPrimarySpeciesFromList(list);
    paragraphs.push(
      "Trivia drop: " + getSpeciesTriviaLine(primarySpecies) +
      " Translation: this is educational, timely, and still ridiculous in the best possible way."
    );
    paragraphs.push(
      "Behind the scenes: HH5HH's GetBirds app keeps the production line moving faster than legacy tap-heavy workflows, " +
      "so @BirdsOfBroomfield spends more time watching birds and less time wrestling UI."
    );
    paragraphs.push(pickSeeded(finaleTemplates, seed, "finale"));
    paragraphs.push("For more episodes, field notes, and feathered plot twists, follow @BirdsOfBroomfield on IG.");

    var base = paragraphs.join("\n\n");
    return expandDescriptionToNearLimit(base, seed, speciesListLabel, createdTitleDate);
  }

  function buildYouTubeSnippetFromPostcard(postcard, videoIndex, totalVideos) {
    var speciesList = normalizeSpeciesListForYouTube(postcard);
    var primarySpecies = pickPrimarySpeciesFromList(speciesList);
    var speciesStr = getPrimarySpeciesForYouTube(postcard);
    var createdTitleDate = formatYouTubeTitleDate(postcard.createdAt);
    var title = speciesStr + " from GetBirds app on " + createdTitleDate + " by @BirdsOfBroomfield";
    if (totalVideos > 1) title += " (" + (videoIndex + 1) + "/" + totalVideos + ")";
    title = clampYouTubeTitle(title);
    var description = buildYouTubeLongDescription(postcard, speciesList, createdTitleDate);
    var tags = ["GetBirds", "BirdBuddy", "bird feeder", "postcard", "hh5hh", "birdsofbroomfield"];
    if (primarySpecies && primarySpecies.toLowerCase() !== "unknown") tags.push(primarySpecies);
    for (var i = 0; i < speciesList.length; i++) {
      var s = speciesList[i];
      if (!s || s.toLowerCase() === "unknown") continue;
      tags.push(s);
    }
    if (postcard.id) tags.push("postcard-" + postcard.id.slice(0, 8));
    tags = dedupeTagList(tags);
    return { title: title, description: description, tags: tags };
  }

  function uploadOneVideoMultipartOnce(blob, metadata, accessToken) {
    var boundary = "ytboundary" + Math.random().toString(36).slice(2, 14);
    var contentType = blob.type || "video/mp4";
    var prefix =
      "--" + boundary + "\r\n" +
      "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
      JSON.stringify(metadata) + "\r\n" +
      "--" + boundary + "\r\n" +
      "Content-Type: " + contentType + "\r\n\r\n";
    var suffix = "\r\n--" + boundary + "--\r\n";
    var body = new Blob([prefix, blob, suffix], { type: "multipart/related; boundary=" + boundary });
    var url = "https://www.googleapis.com/upload/youtube/v3/videos?uploadType=multipart&part=snippet,status";
    return fetch(url, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + accessToken,
        "Content-Type": "multipart/related; boundary=" + boundary
      },
      body: body
    }).then(function (res) {
      return res.text().then(function (text) {
        if (!res.ok) {
          var details = parseYouTubeApiErrorDetails(text, "YouTube upload failed.");
          var err = new Error(details.message);
          err.status = res.status;
          err.raw = text;
          err.youtubeReason = details.reason || "";
          err.youtubeCode = details.code || 0;
          err.retryAfterSeconds = parseRetryAfterSeconds(res.headers && res.headers.get ? res.headers.get("Retry-After") : "");
          throw err;
        }
        if (!text) return {};
        try {
          return JSON.parse(text);
        } catch (_) {
          return {};
        }
      });
    });
  }

  /** Upload with progressive metadata fallbacks for strict videos.insert validation. */
  async function uploadOneVideoMultipart(blob, metadata, accessToken) {
    var attempts = buildYouTubeInsertMetadataAttempts(metadata);
    var lastErr = null;
    for (var i = 0; i < attempts.length; i++) {
      try {
        var result = await uploadOneVideoMultipartOnce(blob, attempts[i], accessToken);
        if (result && typeof result === "object") {
          result.__metadataAttempt = i;
          result.__usedFallback = i > 0;
        }
        return result;
      } catch (err) {
        lastErr = err;
        if (isYouTubeUploadLimitError(err)) throw err;
        var isBadRequest = err && Number(err.status) === 400;
        if (!isBadRequest || i === attempts.length - 1) throw err;
      }
    }
    throw lastErr || new Error("YouTube upload failed.");
  }

  function parseYouTubeApiErrorDetails(text, fallbackMessage) {
    var out = {
      message: fallbackMessage || "YouTube API request failed.",
      reason: "",
      code: 0
    };
    if (!text) return out;
    try {
      var data = JSON.parse(text);
      if (data && data.error) {
        var errObj = data.error;
        out.code = Number(errObj.code) || 0;
        out.message = errObj.message || out.message;
        var first = Array.isArray(errObj.errors) && errObj.errors.length ? errObj.errors[0] : null;
        if (first) {
          if (first.reason) out.reason = String(first.reason);
          if (!out.message && first.message) out.message = String(first.message);
        }
        if (out.reason && out.message.indexOf("[reason: ") === -1) {
          out.message = out.message + " [reason: " + out.reason + "]";
        }
        if (out.message) return out;
      }
    } catch (_) {}
    out.message = text || out.message;
    return out;
  }

  function parseYouTubeApiError(text, fallbackMessage) {
    return parseYouTubeApiErrorDetails(text, fallbackMessage).message;
  }

  function youtubeApiJson(url, opts, fallbackMessage) {
    opts = opts || {};
    return fetch(url, opts).then(function (res) {
      return res.text().then(function (text) {
        if (!res.ok) throw new Error(parseYouTubeApiError(text, fallbackMessage || ("YouTube API request failed (" + res.status + ").")));
        if (!text) return {};
        try {
          return JSON.parse(text);
        } catch (_) {
          return {};
        }
      });
    });
  }

  function updateYouTubeVideoMetadata(accessToken, videoId, metadata) {
    if (!accessToken || !videoId) return Promise.resolve({});
    var safe = sanitizeYouTubeMetadata(metadata);
    return youtubeApiJson("https://www.googleapis.com/youtube/v3/videos?part=snippet,status", {
      method: "PUT",
      headers: {
        "Authorization": "Bearer " + accessToken,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        id: videoId,
        snippet: safe.snippet,
        status: safe.status
      })
    }, "Could not apply full YouTube metadata.");
  }

  function findGetBirdsPlaylistId(accessToken, playlistName) {
    var normalized = String(playlistName || "").trim().toLowerCase();
    var pageToken = "";

    function nextPage() {
      var params = new URLSearchParams({
        part: "snippet",
        mine: "true",
        maxResults: "50"
      });
      if (pageToken) params.set("pageToken", pageToken);
      var url = "https://www.googleapis.com/youtube/v3/playlists?" + params.toString();
      return youtubeApiJson(url, {
        method: "GET",
        headers: { "Authorization": "Bearer " + accessToken }
      }, "Could not list YouTube playlists.")
        .then(function (data) {
          var items = (data && data.items) || [];
          for (var i = 0; i < items.length; i++) {
            var it = items[i] || {};
            var title = (((it.snippet || {}).title) || "").trim().toLowerCase();
            if (title === normalized && it.id) return it.id;
          }
          pageToken = data && data.nextPageToken ? data.nextPageToken : "";
          if (!pageToken) return "";
          return nextPage();
        });
    }

    return nextPage();
  }

  function createGetBirdsPlaylist(accessToken, playlistName) {
    return youtubeApiJson("https://www.googleapis.com/youtube/v3/playlists?part=snippet,status", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + accessToken,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        snippet: {
          title: playlistName,
          description: "Uploads from the GetBirds app."
        },
        status: {
          privacyStatus: "private"
        }
      })
    }, "Could not create the GetBirds playlist.")
      .then(function (data) {
        var id = data && data.id;
        if (!id) throw new Error("Could not create the GetBirds playlist.");
        return id;
      });
  }

  function ensureGetBirdsPlaylist(accessToken) {
    var playlistName = "GetBirds";
    return findGetBirdsPlaylistId(accessToken, playlistName).then(function (existingId) {
      if (existingId) return existingId;
      return createGetBirdsPlaylist(accessToken, playlistName);
    });
  }

  function addVideoToPlaylist(accessToken, playlistId, videoId) {
    if (!playlistId || !videoId) return Promise.resolve();
    return youtubeApiJson("https://www.googleapis.com/youtube/v3/playlistItems?part=snippet", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + accessToken,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        snippet: {
          playlistId: playlistId,
          resourceId: {
            kind: "youtube#video",
            videoId: videoId
          }
        }
      })
    }, "Could not add uploaded video to the GetBirds playlist.");
  }

  function isLikelyJpgMediaUrl(url) {
    var u = String(url || "").toLowerCase();
    return /\.jpe?g(?:$|[?#])/i.test(u);
  }

  function waitMs(ms) {
    return new Promise(function (resolve) { setTimeout(resolve, ms); });
  }

  function getImageCandidateUrls(media) {
    var out = [];
    function push(url) {
      var u = String(url || "").trim();
      if (!u) return;
      if (out.indexOf(u) !== -1) return;
      out.push(u);
    }
    push(media && media.url);
    push(media && media.thumb);
    return out;
  }

  function getFinalThumbnailSourceFromPostcard(postcard) {
    var medias = postcard && postcard.medias ? postcard.medias : [];
    var bestJpg = null;
    var bestAny = null;
    var bestJpgScore = -Infinity;
    var bestAnyScore = -Infinity;
    for (var i = 0; i < medias.length; i++) {
      var m = medias[i];
      if (!m || m.isVideo) continue;
      var score = typeof m.sourceIndex === "number" ? m.sourceIndex : i;
      var urls = getImageCandidateUrls(m);
      if (urls.length === 0) continue;

      if (score >= bestAnyScore) {
        bestAny = { media: m, url: urls[0], isJpg: isLikelyJpgMediaUrl(urls[0]), sourceIndex: score };
        bestAnyScore = score;
      }

      for (var j = 0; j < urls.length; j++) {
        var u = urls[j];
        if (!isLikelyJpgMediaUrl(u)) continue;
        var preferPrimaryUrl = j === 0 ? 1 : 0;
        var candidateScore = score * 10 + preferPrimaryUrl;
        if (candidateScore >= bestJpgScore) {
          bestJpg = { media: m, url: u, isJpg: true, sourceIndex: score };
          bestJpgScore = candidateScore;
        }
      }
    }
    return bestJpg || bestAny || null;
  }

  function imageElementFromBlob(blob) {
    return new Promise(function (resolve, reject) {
      var url = URL.createObjectURL(blob);
      var img = new Image();
      img.onload = function () {
        URL.revokeObjectURL(url);
        resolve(img);
      };
      img.onerror = function () {
        URL.revokeObjectURL(url);
        reject(new Error("Could not decode postcard image for thumbnail."));
      };
      img.src = url;
    });
  }

  function canvasToJpegBlob(canvas, quality) {
    return new Promise(function (resolve, reject) {
      canvas.toBlob(function (blob) {
        if (!blob) {
          reject(new Error("Could not encode thumbnail image."));
          return;
        }
        resolve(blob);
      }, "image/jpeg", quality);
    });
  }

  async function buildYouTubePreviewThumbnailBlob(sourceBlob) {
    if (!sourceBlob) throw new Error("Postcard thumbnail blob is missing.");
    var img = await imageElementFromBlob(sourceBlob);
    var targetWidth = 1280;
    var targetHeight = 720;
    var canvas = document.createElement("canvas");
    canvas.width = targetWidth;
    canvas.height = targetHeight;
    var ctx = canvas.getContext("2d");
    if (!ctx) throw new Error("Could not initialize canvas for thumbnail rendering.");
    var scale = Math.max(targetWidth / img.width, targetHeight / img.height);
    var drawWidth = img.width * scale;
    var drawHeight = img.height * scale;
    var drawX = (targetWidth - drawWidth) / 2;
    var drawY = (targetHeight - drawHeight) / 2;
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, targetWidth, targetHeight);
    ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
    var qualities = [0.9, 0.82, 0.74, 0.66, 0.58];
    var maxBytes = 2 * 1024 * 1024;
    var out = null;
    for (var i = 0; i < qualities.length; i++) {
      out = await canvasToJpegBlob(canvas, qualities[i]);
      if (out.size <= maxBytes) return out;
    }
    if (out && out.size <= maxBytes) return out;
    throw new Error("Prepared thumbnail is larger than YouTube's 2MB limit.");
  }

  function setYouTubeVideoThumbnail(accessToken, videoId, thumbnailBlob) {
    if (!accessToken || !videoId || !thumbnailBlob) return Promise.resolve({});
    var url = "https://www.googleapis.com/upload/youtube/v3/thumbnails/set?uploadType=media&videoId=" + encodeURIComponent(videoId);
    return fetch(url, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + accessToken,
        "Content-Type": "image/jpeg"
      },
      body: thumbnailBlob
    }).then(function (res) {
      return res.text().then(function (text) {
        if (!res.ok) throw new Error(parseYouTubeApiError(text, "Could not set YouTube thumbnail."));
        if (!text) return {};
        try {
          return JSON.parse(text);
        } catch (_) {
          return {};
        }
      });
    });
  }

  function isRetryableYouTubeThumbnailError(err) {
    var msg = err && err.message ? String(err.message) : "";
    return /processing|process|not.?ready|video.?not.?found|notFound|try again|temporar/i.test(msg);
  }

  async function setYouTubeVideoThumbnailWithRetry(accessToken, videoId, thumbnailBlob) {
    var retryDelays = [1500, 3000, 6000, 9000];
    var lastErr = null;
    for (var attempt = 0; attempt <= retryDelays.length; attempt++) {
      try {
        return await setYouTubeVideoThumbnail(accessToken, videoId, thumbnailBlob);
      } catch (err) {
        lastErr = err;
        if (attempt >= retryDelays.length || !isRetryableYouTubeThumbnailError(err)) {
          throw err;
        }
        await waitMs(retryDelays[attempt]);
      }
    }
    throw lastErr || new Error("Could not set YouTube thumbnail.");
  }

  function isCORSOrNetworkError(e) {
    if (!e) return false;
    var msg = (e.message || "") + (e.name || "");
    return e.name === "TypeError" || /Failed to fetch|CORS|Access-Control|network|Load failed|ERR_FAILED/i.test(msg);
  }

  function triggerVideoDownloadsForPostcard(postcard, delayMs) {
    delayMs = delayMs || 400;
    var videos = getPostcardVideoMedia(postcard);
    if (videos.length === 0) return Promise.resolve();
    var links = [];
    mediaGrid.querySelectorAll(".postcard-group").forEach(function (group) {
      if ((group.getAttribute("data-postcard-id") || "") !== (postcard.id || "")) return;
      group.querySelectorAll(".media-link").forEach(function (a) {
        var d = (a.getAttribute("download") || "").toLowerCase();
        if (/\.(mp4|webm|mov)$/.test(d)) links.push(a);
      });
    });
    return triggerDownloadsSequentially(links, delayMs);
  }

  var YOUTUBE_STUDIO_URL = "https://studio.youtube.com";

  function setYouTubeUploadButtonState(button, label) {
    if (!button) return;
    if (activeYouTubeUploadButton && activeYouTubeUploadButton !== button) {
      resetYouTubeUploadButtonState();
    }
    if (!activeYouTubeUploadButton) {
      activeYouTubeUploadButton = button;
      activeYouTubeUploadButtonLabel = button.textContent || "Save to YouTube";
    }
    button.classList.add("btn-uploading");
    button.disabled = true;
    button.setAttribute("aria-busy", "true");
    button.textContent = label || "Uploading…";
  }

  function resetYouTubeUploadButtonState() {
    if (!activeYouTubeUploadButton) return;
    activeYouTubeUploadButton.classList.remove("btn-uploading");
    activeYouTubeUploadButton.removeAttribute("aria-busy");
    activeYouTubeUploadButton.textContent = activeYouTubeUploadButtonLabel || "Save to YouTube";
    var hasVideo = activeYouTubeUploadButton.getAttribute("data-has-video") === "true";
    if (!hasVideo) {
      activeYouTubeUploadButton.disabled = true;
      activeYouTubeUploadButton.setAttribute("aria-disabled", "true");
      activeYouTubeUploadButton.title = "No MP4 video available in this postcard.";
    } else if (isYouTubeUploadBlocked()) {
      activeYouTubeUploadButton.disabled = true;
      activeYouTubeUploadButton.setAttribute("aria-disabled", "true");
      activeYouTubeUploadButton.title = getYouTubeUploadBlockedMessage();
    } else {
      activeYouTubeUploadButton.disabled = false;
      activeYouTubeUploadButton.removeAttribute("aria-disabled");
      activeYouTubeUploadButton.title = "";
    }
    activeYouTubeUploadButton = null;
    activeYouTubeUploadButtonLabel = "";
    applyYouTubeUploadBlockedUi();
  }

  function getStudioUrlForVideo(videoId) {
    if (!videoId) return YOUTUBE_STUDIO_URL;
    return "https://studio.youtube.com/video/" + encodeURIComponent(videoId) + "/edit";
  }

  function openYouTubeStudioPopup(studioUrl) {
    var popup = null;
    try {
      popup = window.open(studioUrl || YOUTUBE_STUDIO_URL, "_blank", "noopener,noreferrer");
    } catch (_) {
      popup = null;
    }
    return !!popup;
  }

  /** Show YouTube modal with message. Only call after upload completes (success or fallback). */
  function openYouTubeUploadModal(opts) {
    opts = opts || {};
    var msg = "";
    if (opts.success && opts.popupBlocked && opts.count != null) {
      msg = "Uploaded " + opts.count + " video(s) to YouTube and published as Public. Your browser blocked the pop-up, so click below to open the uploaded video in YouTube Studio.";
    } else if (opts.success && opts.count != null) {
      msg = "Uploaded " + opts.count + " video(s) to YouTube and published as Public. Open YouTube Studio to edit details.";
    } else if (opts.fallback && opts.count != null) {
      msg = "Upload from this browser was blocked. " + opts.count + " video(s) were downloaded. Open YouTube Studio in a new tab to upload them and set visibility.";
    } else {
      msg = "Open YouTube Studio to manage your videos.";
    }
    if (youtubeModalMessage) youtubeModalMessage.textContent = msg;
    if (youtubeModalOpenStudio) {
      youtubeModalOpenStudio.href = opts.studioUrl || YOUTUBE_STUDIO_URL;
      youtubeModalOpenStudio.textContent = opts.studioUrl ? "Open uploaded video in Studio" : "Open YouTube Studio";
    }
    if (youtubeUploadModalOverlay) youtubeUploadModalOverlay.classList.remove("hidden");
  }

  function closeYouTubeUploadModal() {
    if (youtubeUploadModalOverlay) youtubeUploadModalOverlay.classList.add("hidden");
  }

  /** Upload all postcard videos via multipart (sample-style). Uses GSI accessToken; no gapi/iframe. */
  async function uploadPostcardVideosWithToken(postcard, accessToken, requestCtx) {
    var videos = getPostcardVideoMedia(postcard);
    if (videos.length === 0) {
      setBusy(false);
      resetYouTubeUploadButtonState();
      return;
    }
    mediaError.hidden = true;
    var uploadedVideoIds = [];
    var playlistId = "";
    var playlistWarning = "";
    var metadataWarning = "";
    var thumbnailWarning = "";
    var thumbnailBlob = null;
    try {
      setHeaderStatus("Preparing GetBirds playlist…", false);
      try {
        playlistId = await ensureGetBirdsPlaylist(accessToken);
      } catch (playlistErr) {
        playlistWarning = playlistErr && playlistErr.message ? playlistErr.message : "Could not use the GetBirds playlist.";
      }
      var thumbnailSource = getFinalThumbnailSourceFromPostcard(postcard);
      if (thumbnailSource && thumbnailSource.url) {
        try {
          if (thumbnailSource.isJpg) {
            setHeaderStatus("Preparing final postcard JPG for YouTube thumbnail…", false);
          } else {
            setHeaderStatus("Preparing final postcard image fallback for YouTube thumbnail…", false);
          }
          var thumbnailRes = await fetch(thumbnailSource.url, {
            mode: "cors",
            cache: "no-store",
            credentials: "omit"
          });
          if (!thumbnailRes.ok) throw new Error("Could not fetch postcard thumbnail image (" + thumbnailRes.status + ").");
          var sourceThumbBlob = await thumbnailRes.blob();
          if (!sourceThumbBlob || !sourceThumbBlob.size) throw new Error("Downloaded thumbnail image was empty.");
          thumbnailBlob = await buildYouTubePreviewThumbnailBlob(sourceThumbBlob);
        } catch (thumbErr) {
          thumbnailWarning = thumbErr && thumbErr.message ? thumbErr.message : "Could not prepare postcard thumbnail.";
        }
      }
      for (var i = 0; i < videos.length; i++) {
        var progressMsg = "Uploading video " + (i + 1) + " of " + videos.length + "…";
        setHeaderStatus(progressMsg, false);
        setYouTubeUploadButtonState(requestCtx && requestCtx.button, "Uploading " + (i + 1) + "/" + videos.length + "…");
        var res = await fetch(videos[i].url, { mode: "cors" });
        if (!res.ok) throw new Error("Could not fetch video: " + res.status);
        var blob = await res.blob();
        var snippet = buildYouTubeSnippetFromPostcard(postcard, i, videos.length);
        var tags = snippet.tags && snippet.tags.length ? snippet.tags : ["GetBirds", "BirdBuddy"];
        var metadata = {
          snippet: {
            title: snippet.title || "GetBirds postcard",
            description: snippet.description || "Bird feeder postcard from GetBirds",
            tags: tags,
            categoryId: "22"
          },
          status: {
            privacyStatus: "public",
            selfDeclaredMadeForKids: true
          }
        };
        var uploadResult = await uploadOneVideoMultipart(blob, metadata, accessToken);
        if (uploadResult && uploadResult.id) {
          uploadedVideoIds.push(uploadResult.id);
          if (uploadResult.__usedFallback) {
            try {
              await updateYouTubeVideoMetadata(accessToken, uploadResult.id, metadata);
            } catch (metadataErr) {
              if (!metadataWarning) {
                metadataWarning = metadataErr && metadataErr.message ? metadataErr.message : "Could not apply full YouTube metadata.";
              }
            }
          }
          if (playlistId) {
            try {
              await addVideoToPlaylist(accessToken, playlistId, uploadResult.id);
            } catch (playlistItemErr) {
              if (!playlistWarning) {
                playlistWarning = playlistItemErr && playlistItemErr.message ? playlistItemErr.message : "Could not add one or more videos to the GetBirds playlist.";
              }
            }
          }
          if (thumbnailBlob) {
            try {
              await setYouTubeVideoThumbnailWithRetry(accessToken, uploadResult.id, thumbnailBlob);
            } catch (thumbnailErr) {
              if (!thumbnailWarning) {
                thumbnailWarning = thumbnailErr && thumbnailErr.message ? thumbnailErr.message : "Could not set custom thumbnail on one or more videos.";
              }
            }
          }
        }
      }
      var newestVideoId = uploadedVideoIds.length ? uploadedVideoIds[uploadedVideoIds.length - 1] : "";
      var studioUrl = getStudioUrlForVideo(newestVideoId);
      var successPrefix = "Uploaded " + videos.length + " video(s) and published as Public";
      if (playlistId) {
        successPrefix += " and added to GetBirds playlist";
      } else if (playlistWarning) {
        successPrefix += " (playlist step skipped)";
      }
      if (metadataWarning) {
        successPrefix += " (metadata simplified)";
      }
      if (thumbnailBlob && !thumbnailWarning) {
        successPrefix += " with postcard thumbnail";
      } else if (thumbnailWarning) {
        successPrefix += " (thumbnail step skipped)";
      }
      if (openYouTubeStudioPopup(studioUrl)) {
        setHeaderStatus(successPrefix + " and opened YouTube Studio.", false);
      } else {
        setHeaderStatus(successPrefix + ". Pop-up was blocked — open YouTube Studio manually.", false);
        openYouTubeUploadModal({ success: true, popupBlocked: true, count: videos.length, studioUrl: studioUrl });
      }
    } catch (e) {
      if (isYouTubeUploadLimitError(e)) {
        var until = computeYouTubeUploadBlockedUntilMs(e);
        blockYouTubeUploadsUntil(until, (e && e.message) || youtubeUploadBlockedReason);
        setHeaderStatus(getYouTubeUploadBlockedMessage(), true, { persist: true, youtubeLimit: true });
      } else if (isCORSOrNetworkError(e)) {
        setHeaderStatus("Upload from this browser was blocked. Downloading videos…", false);
        await triggerVideoDownloadsForPostcard(postcard, 350);
        openYouTubeUploadModal({ fallback: true, count: videos.length });
      } else {
        setHeaderStatus(e.message || "YouTube upload failed.", true);
      }
    } finally {
      resetYouTubeUploadButtonState();
      setBusy(false);
    }
  }

  function getTokenClientForYouTube() {
    if (youtubeTokenClient) return youtubeTokenClient;
    if (typeof google === "undefined" || !google.accounts || !google.accounts.oauth2) {
      throw new Error("Google Sign-In not loaded. Reload the page.");
    }
    youtubeTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPE_YOUTUBE,
      callback: function (res) {
        var request = pendingYouTubeUploadRequest;
        pendingYouTubeUploadRequest = null;
        if (res.error) {
          setBusy(false);
          setHeaderStatus(res.error + (res.error_description ? ": " + res.error_description : "") + " Add yourself as a test user in Google Cloud Console if needed.", true);
          resetYouTubeUploadButtonState();
          return;
        }
        localStorage.setItem(STORAGE_KEYS.googleAccessToken, res.access_token);
        if (res.expires_in) localStorage.setItem(STORAGE_KEYS.googleExpiresAt, String(Date.now() + res.expires_in * 1000));
        if (request && request.postcard) {
          uploadPostcardVideosWithToken(request.postcard, res.access_token, request);
        } else {
          setBusy(false);
          resetYouTubeUploadButtonState();
        }
      }
    });
    return youtubeTokenClient;
  }

  function onSaveToYouTube(postcard, button) {
    if (isYouTubeUploadBlocked()) {
      applyYouTubeUploadBlockedUi();
      return;
    }
    var videos = getPostcardVideoMedia(postcard);
    if (videos.length === 0) {
      if (button) {
        button.disabled = true;
        button.setAttribute("aria-disabled", "true");
        button.title = "No MP4 video available in this postcard.";
      }
      setHeaderStatus("No MP4 video in this postcard. Save to collection still works.", true);
      return;
    }
    if (busy) return;
    setBusy(true);
    mediaError.hidden = true;
    setYouTubeUploadButtonState(button, "Authorizing…");
    setHeaderStatus("Requesting YouTube permission…", false);
    pendingYouTubeUploadRequest = { postcard: postcard, button: button };
    try {
      getTokenClientForYouTube().requestAccessToken();
    } catch (e) {
      setBusy(false);
      pendingYouTubeUploadRequest = null;
      resetYouTubeUploadButtonState();
      setHeaderStatus(e.message || "Could not request YouTube access.", true);
    }
  }

  async function onDownloadAllClick() {
    if (busy) return;
    setBusy(true);
    try {
      if (hasMore) {
        mediaStatus.hidden = false;
        mediaStatus.textContent = "Loading all postcards…";
        await loadAllPostcards();
      }
      var c = getDisplayedCounts();
      if (c.media === 0) return;
      mediaStatus.textContent = "Downloading…";
      mediaStatus.hidden = false;
      if (footerStats) footerStats.textContent = "Downloading " + c.media + " file(s)…";
      await triggerAllDownloads();
      mediaStatus.hidden = true;
      if (footerStats) footerStats.textContent = "All media download started — check your browser downloads.";
      setHeaderStatus("Download started for all media. Check your browser downloads.", false);
      setTimeout(updateFooter, 2000);
    } catch (e) {
      mediaStatus.hidden = true;
      setHeaderStatus(e.message || "Download failed", true);
      if (footerStats) footerStats.textContent = "Download failed.";
      setTimeout(updateFooter, 2000);
    } finally {
      setBusy(false);
    }
  }

  function getTokenClient() {
    if (tokenClient) return tokenClient;
    if (typeof google === "undefined" || !google.accounts || !google.accounts.oauth2) {
      throw new Error("Google Sign-In script not loaded yet. Try again in a moment.");
    }
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPE,
      callback: function (res) {
        if (res.error) {
          setBusy(false);
          showLogin();
          return;
        }
        onGoogleTokenReceived(res.access_token, res.expires_in || 3600);
      }
    });
    return tokenClient;
  }

  function onGoogleTokenReceived(accessToken, expiresIn) {
    var expiresAt = Date.now() + expiresIn * 1000;
    localStorage.setItem(STORAGE_KEYS.googleAccessToken, accessToken);
    localStorage.setItem(STORAGE_KEYS.googleExpiresAt, String(expiresAt));
    fetch(USERINFO_URL, { headers: { Authorization: "Bearer " + accessToken, Accept: "application/json" } })
      .then(function (r) { return r.json(); })
      .then(function (profile) {
        if (!profile.sub) throw new Error(profile.error || "Profile failed");
        localStorage.setItem(STORAGE_KEYS.picture, profile.picture || "");
        localStorage.setItem(STORAGE_KEYS.name, profile.name || "");
        showLoggedIn({ picture: profile.picture, name: profile.name });
      })
      .catch(function () { showLogin(); })
      .finally(function () { setBusy(false); });
  }

  /* Google token treated as expired this many ms before expiry (force re-sign-in). */
  var GOOGLE_TOKEN_BUFFER_MS = 60 * 1000;

  async function restoreSession() {
    var token = localStorage.getItem(STORAGE_KEYS.googleAccessToken);
    var expiresAt = parseInt(localStorage.getItem(STORAGE_KEYS.googleExpiresAt) || "0", 10);
    if (!token || !expiresAt || Date.now() >= expiresAt - GOOGLE_TOKEN_BUFFER_MS) return false;
    try {
      var r = await fetch(USERINFO_URL, { headers: { Authorization: "Bearer " + token, Accept: "application/json" } });
      var profile = await r.json();
      if (!r.ok || !profile.sub) return false;
      localStorage.setItem(STORAGE_KEYS.picture, profile.picture || "");
      localStorage.setItem(STORAGE_KEYS.name, profile.name || "");
      showLoggedIn({ picture: profile.picture, name: profile.name });
      return true;
    } catch (_) { return false; }
  }

  function clearSession() {
    [
      STORAGE_KEYS.googleAccessToken,
      STORAGE_KEYS.googleExpiresAt,
      STORAGE_KEYS.picture,
      STORAGE_KEYS.name,
      STORAGE_KEYS.bbAccessToken,
      STORAGE_KEYS.bbExpiresAt,
      STORAGE_KEYS.bbRefreshToken
    ].forEach(function (key) { localStorage.removeItem(key); });
  }

  async function signOut() {
    var token = localStorage.getItem(STORAGE_KEYS.googleAccessToken);
    if (token) {
      try {
        await fetch(REVOKE_URL, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: new URLSearchParams({ token: token }).toString() });
      } catch (_) {}
    }
    clearSession();
    resetLoggedInUI();
    showLogin();
  }

  function startLogin() {
    setBusy(true);
    try {
      getTokenClient().requestAccessToken();
    } catch (_) {
      setBusy(false);
      showLogin();
    }
  }

  loadMoreBtn.addEventListener("click", function () {
    if (!hasMore || busy) return;
    mediaStatus.hidden = false;
    mediaStatus.textContent = "Loading more…";
    loadMoreBtn.hidden = true;
    loadAllBtn.hidden = true;
    fetchBirdBuddyFeed();
  });

  loadAllBtn.addEventListener("click", loadAllPostcards);

  if (downloadAllBtn) {
    downloadAllBtn.addEventListener("click", function () { onDownloadAllClick(); });
  }
  if (downloadAllMediaBtn) {
    downloadAllMediaBtn.addEventListener("click", function () { onDownloadAllClick(); });
  }

  loginBtn.addEventListener("click", function () {
    if (busy) return;
    startLogin();
  });

  signoutBtn.addEventListener("click", function () {
    if (busy) return;
    setBusy(true);
    signOut().finally(function () { setBusy(false); });
  });

  if (youtubeModalClose) {
    youtubeModalClose.addEventListener("click", closeYouTubeUploadModal);
  }
  if (youtubeUploadModalOverlay) {
    youtubeUploadModalOverlay.addEventListener("click", function (e) {
      if (e.target === youtubeUploadModalOverlay) closeYouTubeUploadModal();
    });
  }

  syncGraphqlOverrideFromUrl();
  restoreYouTubeUploadBlockedState();

  setBusy(true);
  restoreSession().then(function (ok) {
    if (!ok) showLogin();
  }).catch(function () {
    showLogin();
  }).finally(function () { setBusy(false); });

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function () {});
  }
})();
  </script>
</body>
</html>
